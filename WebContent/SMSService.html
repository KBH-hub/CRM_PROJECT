<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>메시지 전송</title>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="sidebar.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

<style>
/* 부드러운 페이드 전환 */
.fade-section {
	opacity: 0;
	transition: opacity 0.4s ease-in-out;
	display: none;
}

.fade-section.show {
	display: block;
	opacity: 1;
}

.custom-modal-size {
	height: 80vh;
	max-height: 100%;
}

.table thead th {
	text-align: center;
}

.table tbody td {
	vertical-align: middle;
	text-align: center;
}

#pager .page-item.active .page-link {
	background: #212529;
	color: #fff;
	border-color: #212529;
	border-radius: .6rem;
}

#pager .page-item.disabled .page-link {
	color: #bbb;
	pointer-events: none;
	background: transparent;
	border-color: transparent;
}

#pager .page-link {
	border: none;
	background: transparent;
	color: #4a4a4a;
}

#tampleteTable td {
  white-space: normal;     /* 자동 줄바꿈 허용 */
  word-break: break-word;  /* 긴 단어도 줄바꿈 */
  background-color: #fff;  /* 내용은 흰색 */
}

#tampleteTable tbody td:nth-child(2) {
  text-align: left;
  padding-left: 12px; /* 살짝 여백 추가 (선택사항) */
}

#tampleteTable tbody tr {
  cursor: pointer;
}
#tampleteTable tbody tr.active-template {
  background-color: #eaf4ff !important;
  border-left: 4px solid #0d6efd;
  font-weight: 600;
}

</style>
</head>
<body class="bg-body-tertiary">
	<div class="container-fluid">
		<div class="row">

			<!-- 여기서 사이드바를 주입 -->
			<div id="sidebar-slot" class="col-2 p-0"></div>

			<!-- 메인 -->
			<main class="col-10 p-4">
			
			<div class="container py-4">
				<h2 class="text-center mb-4">메시지 서비스</h2>

				<!-- ✅상단 탭 -->
				<ul class="nav nav-tabs justify-content-center mb-3"
					id="messageTabs">
					<li class="nav-item">
						<button id="reserveBtn" class="nav-link active">예약 메시지</button>
					</li>
					<li class="nav-item">
						<button id="commonBtn" class="nav-link">일반 메시지</button>
					</li>
				</ul>

				<!-- ✅ 예약 메시지 구역 -->
				<div class="reserveSMS fade-section show">

					<div class="row justify-content-center align-items-start mt-3">
						<!-- 왼쪽 영역 -->
						<div class="col-md-6 text-center">
							<textarea id="templateContentBox"
								class="form-control w-75 mx-auto mb-3" rows="10"
								placeholder="템플릿을 선택하세요." readonly></textarea>
							<button type="button" class="btn btn-secondary btn-sm"
								data-bs-toggle="modal" data-bs-target="#managerReservationModal">명단
								추가</button>
							<input id="templateNameBox" type="text"
								class="form-control d-inline-block w-50 ms-2 mt-2"
								placeholder="템플릿명" disabled>
							<div class="mt-3 w-75 mx-auto border rounded overflow-auto"
								style="height: 300px;">
								<table class="table table-sm mb-0 text-center align-middle">
									<thead>
										<tr>
											<th style="width: 40%; background: transparent;">이름</th>
											<th style="width: 60%; background: transparent;">전화번호</th>
										</tr>
									</thead>
									<tbody id="reserveRecipientTableBody"
										style="background: transparent;">
										<!-- modal -->
									</tbody>
								</table>
							</div>
							<p class="text-end w-75 mx-auto mt-2 text-muted"
								id="reserveRecipientCount">수신자 : 0명</p>
							<div
								class="mb-4 d-flex justify-content-between align-items-center w-75 mx-auto">
								<button type="button" class="btn btn-outline-secondary"
									id="reserveSMSRecord">보낸 메시지함</button>
								<div class="d-flex gap-2">
									<button type="button" class="btn btn-warning btn-sm btnReset">초기화</button>
									<button id="sendReserveSMSbtn" type="button"
										class="btn btn-success btn-sm">전송</button>
								</div>
							</div>
						</div>

						<!-- ✅ 오른쪽 영역 -->
						<div class="col-md-6">
							<div class="d-flex justify-content-center mb-2">
								<input id="templateName" type="text" class="form-control w-75"
									placeholder="템플릿명 검색">
								<button id="btnSearch" class="btn btn-primary ms-2">
									검색 <span id="loading" class="spinner" aria-hidden="true"></span>
								</button>
							</div>

							<div class="w-100 mx-auto table-responsive">
								<table id="tampleteTable"
									class="table table-hover table-bordered align-middle mb-0">
									<thead class="table-light text-center">
										<tr>
											<th style="width: 30%;">템플릿 명</th>
											<th style="width: 70%;">템플릿 내용</th>
										</tr>
									</thead>
									<tbody>
										<!-- JS에서 렌더링 -->
									</tbody>
								</table>
							</div>


						</div>
					</div>
				</div>

				<!-- ✅ 일반 메시지 구역 -->
				<div class="commonSMS fade-section">
					<div class="text-center">
						<textarea id="contentBox" class="form-control w-75 mx-auto mb-3"
							rows="10" placeholder="메시지 내용을 입력하세요."></textarea>
						<button type="button" class="btn btn-secondary btn-sm"
							data-bs-toggle="modal" data-bs-target="#patientListModal"
							id="commonSMSAddBtn">명단 추가</button>
						<div class="mt-3 w-75 mx-auto border rounded overflow-auto"
							style="height: 300px;">
							<table class="table table-sm mb-0 text-center align-middle">
								<thead>
									<tr>
										<th style="width: 40%; background: transparent;">이름</th>
										<th style="width: 60%; background: transparent;">전화번호</th>
									</tr>
								</thead>
								<tbody id="recipientTableBody" style="background: transparent;">
									<!-- modal -->
								</tbody>
							</table>
						</div>
						<p class="text-end w-75 mx-auto mt-2 text-muted"
							id="recipientCount">수신자 : 0명</p>

						<button type="button" class="btn btn-warning btn-sm btnReset">초기화</button>
						<button id="sendCommonSMSbtn" type="button"
							class="btn btn-success btn-sm">전송</button>
						<button type="button" class="btn btn-outline-secondary btn-sm"
							id="commonSMSRecord">보낸 메세지함</button>
					</div>
				</div>
			</div>



			<!-- ✅ 예약메시지-명단추가 모달 -->
			<div class="modal fade" id="managerReservationModal" tabindex="-1"
				aria-hidden="true">
				<div
					class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
					<div class="modal-content custom-modal-size">

						<div class="modal-header">
							<div class="d-flex gap-2">
								<h5 class="modal-title fw-bold">예약 목록(SMS)</h5>
							</div>
							<div>
								<button class="btn btn-primary" data-bs-dismiss="modal">닫기</button>
							</div>
						</div>

						<div class="modal-body">
							<div class="row mb-3">
								<div class="row g-3 mb-3 align-items-end">
									<div class="col-md-3">
										<label class="form-label">월</label> <input type="month"
											id="filterMonth" class="form-control">
									</div>
									<div class="col-md-3">
										<label class="form-label">주(월~일)</label> <select
											id="filterWeek" class="form-select">
											<option value="">주 선택</option>
											<!-- JS가 9월 15일 - 9월 21일 형식 옵션 자동 생성 -->
										</select> <input type="hidden" id="filterWeekStart"> <input
											type="hidden" id="filterWeekEnd">
									</div>
									<!-- 일 -->
									<div class="col-md-3">
										<label class="form-label">일</label> <select id="filterDay"
											class="form-select" disabled>
											<option value="">주를 먼저 선택하세요</option>
										</select>
									</div>
									<div class="col-md-3">
										<label class="form-label">시간</label> <select id="filterHour"
											class="form-select" disabled>
											<option value="">전체</option>
											<option value="07">07시</option>
											<option value="08">08시</option>
											<option value="09">09시</option>
											<option value="10">10시</option>
											<option value="11">11시</option>
											<option value="12">12시</option>
											<option value="13">13시</option>
											<option value="14">14시</option>
											<option value="15">15시</option>
											<option value="16">16시</option>
											<option value="17">17시</option>
											<option value="18">18시</option>
											<option value="19">19시</option>
										</select>
									</div>
								</div>

								<div class="table-responsive">
									<table id="reserveTable"
										class="table table-bordered text-center align-middle">
										<thead class="table-light">
											<tr>
												<th scope="col"><input type="checkbox"
													class="select-all"></th>
												<th scope="col">이름</th>
												<th scope="col">방문 예정 일</th>
												<th scope="col">방문 예정 시간</th>
												<th scope="col">담당의사</th>
												<th scope="col">진료과</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td colspan="6" class="text-muted">검색 결과가 없습니다.</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>


						</div>
						<div class="modal-footer d-flex justify-content-between">
							<div class="d-flex gap-2">
								<button id="sendReserveSMSSelectBtn" class="btn btn-primary"
									data-bs-dismiss="modal">선택 환자 메시지 보내기</button>
							</div>
						</div>
					</div>
				</div>


			</div>
			<!-- ✅ 일반메시지-명단추가 모달 -->
			<div class="modal fade" id="patientListModal" tabindex="-1"
				aria-hidden="true">
				<div
					class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
					<div class="modal-content custom-modal-size">
						<div
							class="modal-header d-flex justify-content-between align-items-center">
							<h5 class="modal-title fw-bold">환자 목록 (SMS)</h5>
							<button class="btn btn-primary" data-bs-dismiss="modal">닫기</button>
						</div>
						<div class="modal-body">
							<div class="card">
								<div class="card-body">
									<div
										class="mb-4 d-flex flex-wrap justify-content-between align-items-center">
										<div class="d-flex flex-wrap gap-2 align-items-center">
											<input type="date" id="startDate" class="form-control w-auto">
											<input type="date" id="endDate" class="form-control w-auto">
											<select id="doctorSelect" class="form-select"
												style="width: 250px;">
											</select> <select id="searchType" class="form-select w-auto">
												<option value="name">이름</option>
												<option value="birth">생년월일</option>
											</select> <input type="text" id="keyword" class="form-control w-auto"
												placeholder="검색어 입력">
											<button class="btn btn-primary" id="searchBtn">검색</button>
										</div>
									</div>

									<div class="table-responsive">
										<table class="table table-bordered align-middle text-center"
											style="table-layout: fixed; width: 100%;">
											<thead class="table-light">
												<tr>
													<th style="width: 4%;"><input type="checkbox"
														class="select-all"></th>
													<th style="width: 5%;">환자등록번호</th>
													<th style="width: 10%;">이름</th>
													<th style="width: 12%;">전화번호</th>
													<th style="width: 10%;">최근내원일</th>
													<th style="width: 10%;">담당의사</th>
													<th style="width: 10%;">진료과</th>
													<th style="width: 10%;">보험 종류</th>
													<th style="width: 25%;">진단명</th>
												</tr>
											</thead>
											<tbody id="patientTableBody"></tbody>
										</table>
									</div>
									<nav aria-label="페이지 이동"
										class="d-flex justify-content-center my-3">
										<ul id="pager"
											class="pagination pagination-sm align-items-center gap-2"></ul>
									</nav>
								</div>
							</div>

						</div>

						<div class="modal-footer d-flex justify-content-between">
							<div>
								<button id="sendCommonSMSSelectBtn" class="btn btn-primary"
									data-bs-dismiss="modal">선택 환자 메시지 보내기</button>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
		</main>
	</div>
	</div>
	<div class="modal fade" id="alertModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content text-center border border-primary">
				<div class="modal-body">
					<p id="alertMessage" class="fs-5 fw-bold mb-4 text-dark"></p>
					<div class="d-flex justify-content-center">
						<button type="button" class="btn btn-primary px-4"
							data-bs-dismiss="modal">확인</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
	
	  // sidebar.html을 불러와서 #sidebar-slot에 삽입
	function loadSidebar(activeKey) {
	  $.ajax({
	    url: "./sidebar.html",
	    dataType: "html",
	    success: function (html) {
	      $("#sidebar-slot").html(html);
	      var $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
	      $links.removeClass("active bg-primary text-white").addClass("text-dark");
	      var $current = $links.filter("[data-route='" + activeKey + "']");
	      $current.addClass("active bg-primary text-white").removeClass("text-dark");
	      loadSidebarInfo();
	    }
	  });
	}

	  // 이 페이지의 활성 키만 바꿔주면 됨
	  loadSidebar('SMSService');
	  </script>

	<script type="text/javascript">
	  function showAlert(message, onClose) {
		  $("#alertMessage").text(message);
		  var modal = new bootstrap.Modal(document.getElementById("alertModal"));
		  $("#alertModal").on("hidden.bs.modal", function handler() {
		    if (typeof onClose === "function") onClose();
		    $("#alertModal").off("hidden.bs.modal", handler);
		  });
		  modal.show();
		}
	//template 리스트 불러오기
	$(function(){
		//페이지 로드 시, 전체 리스트 출력
		loadTemplate();
		
		//검색 버튼
		$("#btnSearch").on("click", loadTemplate);
		
		//엔터로 검색
		$("#templateName").on("keydown", function(e){
			if (e.key == "Enter") loadTemplate();
		});
	})
	
  	function loadTemplate() {
      const name = $("#templateName").val().trim();

      $.ajax({
    	    url: "controller",
    	    method: "GET",
    	    dataType: "json",
    	    data: { cmd: "getTemplate", templateName: name },
    	    success: renderList,
    	    error: function(xhr, status, err) {
    	      console.error(err);
    	      $("#tampleteTable tbody").html(`
    	    	        <tr><td colspan="2" class="text-danger text-center">
    	    	          불러오기 실패: ${(xhr.responseText || status)}
    	    	        </td></tr>
    	    	        `);
    	    }
    	  });
     }
	
    //초기화 버튼
	$(".btnReset").on("click", function() {
		reset();
	});
    
    function reset(){
		  $("#templateContentBox").val("");
		  $("#templateNameBox").val("");
		  $("#tampleteTable .active-template").removeClass("active-template");
		  $("#templateName").val(""); // 템플릿 검색어도 비우고 싶으면 유지
		  
		  $("#contentBox").val("");
		  $("#recipientTableBody").empty();
		  $("#recipientCount").text("수신자 : 0명");
		  $("#commonSMSAddBtn").prop("disabled", false);
		  $("#reserveRecipientTableBody").empty();
		  $("#reserveRecipientCount").text("수신자 : 0명");
		  
		  // 선택 상태(공통) 초기화
		  selectedIds = [];
		  selectedRecipients = [];

		  // 모달 내 체크박스들 초기화(선택 전체/행 체크)
		  $('.select-all').each(function(){
		    this.checked = false;
		    this.indeterminate = false;
		  });
		  $('.row-check').prop('checked', false);
    }
 // JSON 배열 → 테이블 렌더링
    function renderList(list) {
      const $tbody = $("#tampleteTable tbody").empty();

      if (!Array.isArray(list) || list.length === 0) {
        $tbody.append(`
          <tr>
            <td colspan="2" class="text-center text-muted">검색 결과가 없습니다.</td>
          </tr>
        `);
        return;
      }

      list.forEach(row => {
        const name = row.templateName || "";
        const content = row.templateContent || "";

        const $tr = $(`
          <tr>
            <td class="text-truncate" title="${name}"></td>
            <td class="text-truncate" title="${content}"></td>
          </tr>
        `);

        $tr.children().eq(0).text(name);
        $tr.children().eq(1).text(content);

        // ✅ 클릭 시 왼쪽 박스 채우고 행 하이라이트
        $tr.on("click", function () {
          $("#templateNameBox").val(name);
          $("#templateContentBox").val(content);

          $("#tampleteTable .active-template").removeClass("active-template");
          $(this).addClass("active-template");
        });

        $tbody.append($tr);
      });
    }

    //보낸 메시지함 클릭
     $("#reserveSMSRecord").on("click", ()=> location.href="controller?cmd=SMSRecordUI");
    
	// ✅ 기본html 관련 js 
	  const reserveBtn = document.getElementById('reserveBtn');
	  const commonBtn  = document.getElementById('commonBtn');
	  const reserveSec = document.querySelector('.reserveSMS');
	  const commonSec  = document.querySelector('.commonSMS');

	  function showSection(showEl, hideEl, activeBtn, inactiveBtn) {
	    hideEl.classList.remove('show');
	    activeBtn.classList.add('active');
	    inactiveBtn.classList.remove('active');
	    setTimeout(() => {
	      hideEl.style.display = 'none';
	      showEl.style.display = 'block';
	      setTimeout(() => showEl.classList.add('show'), 10);
	    }, 200);
	  }

	  reserveBtn.addEventListener('click', () => {
	    showSection(reserveSec, commonSec, reserveBtn, commonBtn);
	    reset();
	  });

	  commonBtn.addEventListener('click', () => {
	    showSection(commonSec, reserveSec, commonBtn, reserveBtn);
	    reset();
	  });

	//======일반메시지 보내기=======
	$("#sendCommonSMSbtn").on("click", function(){
		 const content = $("#contentBox").val().trim();

		  if (selectedRecipients.length === 0) {
		    showAlert("수신자 명단이 비어 있습니다. 먼저 명단을 추가하세요.");
		    return;
		  }
		  if (!content) {
		    showAlert("메시지 내용을 입력하세요.");
		    return;
		  }
		  
		  $.ajax({
			  url: "controller?cmd=sendCommonSMS",
			  type: "post",
			  data: {
				  patientNo: selectedRecipients.map(r => r.patientNo),
				  patientName: selectedRecipients.map(r => r.patientName),
				  phone: selectedRecipients.map(r => r.phone),
				  content: content
			  },
			  traditional: true,
			  dataType: "json",
			  success: function(data){
				  const res = String(data).trim(); // "success"
				    if (res === "success"){
				      showAlert("메시지 전송 성공", reset);
				    } else {
				      showAlert("전송 실패");
				    }
			  },
			    error: function(xhr, status, err) {
			        console.error("전송 중 오류:", err);
			        showAlert("전송 중 오류가 발생했습니다.");
			      }
		  })

	})
	
		//======예약자 메시지 보내기=======
	$("#sendReserveSMSbtn").on("click", function(){
		 const templateName = $("#templateNameBox").val().trim();

		  if (selectedRecipients.length === 0) {
		    showAlert("수신자 명단이 비어 있습니다. 먼저 명단을 추가하세요.");
		    return;
		  }
		  if (!templateName) {
		    showAlert("템플릿을 선택하세요.");
		    return;
		  }
		  
		  $.ajax({
			  url: "controller?cmd=sendReserveSMS",
			  type: "post",
			  data: {
				  reserveNo: selectedRecipients.map(r => r.reserveNo),
				  patientName: selectedRecipients.map(r => r.patientName),
				  phone: selectedRecipients.map(r => r.phone),
				  templateName: templateName
			  },
			  traditional: true,
			  dataType: "json",
			  success: function(data){
				  const res = String(data).trim(); // "success"
				    if (res === "success"){
				      showAlert("메시지 전송 성공", reset);
				    } else {
				      showAlert("전송 실패");
				    }
			  },
			    error: function(xhr, status, err) {
			        console.error("전송 중 오류:", err);
			        showAlert("전송 중 오류가 발생했습니다.");
			      }
		  })

	})
	  
	// ✅ 명단추가 모달 js
	document.addEventListener('DOMContentLoaded', () => {
  // 각 모달(또는 원하는 컨테이너)마다 select-all 로직을 연결
  ['#managerReservationModal', '#patientListModal'].forEach(selector => {
    const container = document.querySelector(selector);
    if (!container) return;

    const selectAll = container.querySelector('.select-all');
    const getRows = () => Array.from(container.querySelectorAll('.row-check')).filter(cb => !cb.disabled);

    if (!selectAll) return;

    // 전체선택 클릭
    selectAll.addEventListener('change', () => {
      getRows().forEach(cb => cb.checked = selectAll.checked);
      selectAll.indeterminate = false;
    });

    // 행 체크 변경(이벤트 위임으로 동적 추가에도 대응)
    container.addEventListener('change', (e) => {
      if (!e.target.classList.contains('row-check')) return;
      const rows = getRows();
      const checked = rows.filter(cb => cb.checked).length;

      if (rows.length === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        return;
      }

      selectAll.checked = checked === rows.length;
      selectAll.indeterminate = checked > 0 && checked < rows.length;
    });
  });
});
	// 예약목록 모달
	// ===== 유틸 =====
const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
const ymd = d => { const t=new Date(d.getTime()); const Y=t.getFullYear(), M=String(t.getMonth()+1).padStart(2,'0'), D=String(t.getDate()).padStart(2,'0'); return `${Y}-${M}-${D}`; };
const formatKo = d => `${d.getMonth()+1}월 ${d.getDate()}일`;
const getMonday = d => { const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; };

// 월의 주(월~일) 목록 만들기
function buildWeeksForMonth(year, month){
  const first = new Date(year, month-1, 1);
  const last  = new Date(year, month, 0);
  let curMon  = getMonday(first);
  const weeks = [];
  while (curMon <= last){
    const start = new Date(curMon), end = addDays(start, 6);
    weeks.push({ start, end });
    curMon = addDays(curMon, 7);
  }
  return weeks;
}

// 주 셀렉트 옵션 렌더 (선택은 하지 않음 → 사용자가 직접 고르게)
function renderWeekOptions(year, month){
  const $sel = $('#filterWeek').empty().append('<option value="">주 선택</option>');
  buildWeeksForMonth(year, month).forEach(({start, end})=>{
    const val = `${ymd(start)}|${ymd(end)}`;
    const label = `${formatKo(start)} - ${formatKo(end)}`;
    $sel.append(new Option(label, val));
  });

  // 주를 강제로 자동 선택하지 않음 → day는 계속 disabled 상태 유지
  $('#filterWeekStart, #filterWeekEnd').val('');
  $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
}

// 선택된 주의 7일을 day 옵션으로 렌더
function renderDayOptionsByWeek(){
  const ws = $('#filterWeekStart').val(), we = $('#filterWeekEnd').val();
  const $day = $('#filterDay').empty();
  if (!ws || !we){
    $day.prop('disabled', true).append('<option value="">주를 먼저 선택하세요</option>');
    return;
  }
  $day.prop('disabled', false).append(new Option('전체', ''));
  const start = new Date(ws);
  for (let i=0;i<7;i++){
    const d = addDays(start, i);
    $day.append(new Option(formatKo(d), ymd(d)));
  }
  // 기본은 '전체'
  $day.val('');
}

// ===== 이벤트 바인딩 =====

// 모달 열릴 때: 오늘 월 세팅 + 주 목록 생성(자동선택 안 함) + 기본 조회(주 조건 없이 오늘/시간만으로 조회 필요시 조정)
document.getElementById('managerReservationModal')
  .addEventListener('shown.bs.modal', () => {
    const today = new Date();
    const yyyy  = today.getFullYear();
    const mm    = String(today.getMonth()+1).padStart(2,'0');
    $('#filterMonth').val(`${yyyy}-${mm}`);
    $('#filterHour').val('').prop('disabled', true);
    renderWeekOptions(yyyy, parseInt(mm,10));
    // 필요하다면 여기서 오늘이 속한 주를 자동 선택하도록 바꿀 수도 있음(지금은 사용자 선택 강제)
    loadReserveList(); // 주가 비어있으면 week/day 없이 조회 (백엔드에서 month/hour만 적용되도록 <choose>로 처리)
  });

// 월 변경 → 주 옵션 재생성 + day 비활성화 + 즉시 조회
$('#filterMonth').on('change', function(){
  const v = $(this).val();
  $('#filterHour').val('').prop('disabled', true);
  if (!v){
    $('#filterWeek').empty().append('<option value="">주 선택</option>');
    $('#filterWeekStart,#filterWeekEnd').val('');
    $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
    loadReserveList();
    return;
  }
  const [y, m] = v.split('-').map(Number);
  renderWeekOptions(y, m);
  loadReserveList();
});

// ✅ 주 선택 → hidden 세팅 + 7일 옵션 생성 + 즉시 조회
$('#filterWeek').on('change', function(){
  const val = $(this).val(); // "YYYY-MM-DD|YYYY-MM-DD" 또는 ""
  $('#filterHour').val('').prop('disabled', true);
  if (!val){
    $('#filterWeekStart,#filterWeekEnd').val('');
    $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
    loadReserveList();
    return;
  }
  const [ws, we] = val.split('|');
  $('#filterWeekStart').val(ws);
  $('#filterWeekEnd').val(we);
  renderDayOptionsByWeek();
  loadReserveList();
});

// 일 선택 - 주 선택시 가능
$('#filterDay').on('change', function(){
  const hasDay = (($(this).val() || '') !== '');
  if (hasDay) {
    $('#filterHour').prop('disabled', false);
  } else {
    $('#filterHour').val('').prop('disabled', true);
  }
  loadReserveList();
});

// 시간 선택 → 즉시 조회
$('#filterHour').on('change', loadReserveList);

// ===== 예약목록 조회 AJAX =====
function loadReserveList(){
  const params = {
    cmd: 'reserveListModal',
    month:     $('#filterMonth').val()     || '',
    weekStart: $('#filterWeekStart').val() || '',
    weekEnd:   $('#filterWeekEnd').val()   || '',
    day:       $('#filterDay').prop('disabled') ? '' : ($('#filterDay').val() || ''), // 주 미선택 시 day는 비움
    hour:      $('#filterHour').val()      || ''
  };
  $.ajax({
    url: 'controller',
    method: 'GET',
    dataType: 'json',
    data: params,
    success: renderReserveList,
    error: () => $('#reserveTable tbody').html('<tr><td colspan="6" class="text-danger">불러오기 실패</td></tr>')
  });
}

function renderReserveList(reserveList){
  const $tbody = $('#reserveTable tbody').empty();
  if (!reserveList || reserveList.length === 0){
    $tbody.html('<tr><td colspan="6" class="text-muted">검색 결과가 없습니다.</td></tr>');
    return;
  }
  reserveList.forEach(r=>{
	    const $tr = $('<tr>').attr('data-reserve-no', r.reserveNo || '');
	    // 체크박스 열
	    $tr.append('<td><input type="checkbox" class="row-check"></td>');
	    // 데이터 열들
	    $tr.append($('<td>').text(r.patientName  || ''));
	    $tr.append($('<td>').text(r.reserveDay   || ''));
	    $tr.append($('<td>').text(r.reserveTime  || ''));
	    $tr.append($('<td>').text(r.employeeName || ''));
	    $tr.append($('<td>').text(r.department   || ''));
	    $tbody.append($tr);
	  });
}

	// ========환자추가 모달=========
function renderTable(list) {
  var $tbody = $("#patientTableBody");
  $tbody.empty();
  if (!list || list.length === 0) {
    $tbody.html("<tr><td colspan='10' class='text-center text-muted py-3'>조회된 환자 정보가 없습니다.</td></tr>");
    return;
  }
  $.each(list, function(i, p) {
    var tr = `
      <tr>
        <td><input type="checkbox" class="row-check"></td>
        <td>${p.patientNo || '-'}</td>
        <td>${p.patientName || '-'}</td>
        <td>${p.phone || '-'}</td>
        <td>${p.medicalDate || '-'}</td>
        <td>${p.employeeName || '-'}</td>
        <td>${p.department || '-'}</td>
        <td>${p.status || '-'}</td>
        <td>${p.diagnosis || '-'}</td>
      </tr>`;
    $tbody.append(tr);
  });
}

function renderPager(totalCount) {
  var $pager = $("#pager");
  $pager.empty();
  if (totalCount === 0 || totalPages <= 1) return;
  function addBtn(label, action, disabled, active) {
    var li = `<li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                <button class="page-link" data-action="${action}">${label}</button></li>`;
    $pager.append(li);
  }
  addBtn("«", "first", currentPage === 1);
  addBtn("‹", "prev", currentPage === 1);
  for (var i = 1; i <= totalPages; i++) addBtn(i, "", false, i === currentPage);
  addBtn("›", "next", currentPage === totalPages);
  addBtn("»", "last", currentPage === totalPages);
  $pager.find(".page-link").click(function() {
    var act = $(this).data("action");
    var text = $(this).text();
    if ($.isNumeric(text)) loadPatientList(Number(text));
    else if (act === "first") loadPatientList(1);
    else if (act === "prev" && currentPage > 1) loadPatientList(currentPage - 1);
    else if (act === "next" && currentPage < totalPages) loadPatientList(currentPage + 1);
    else if (act === "last") loadPatientList(totalPages);
  });
}

var pageSize = 10;
var currentPage = 1;
var totalPages = 1;
var currentFilter = {
  startDate: "",
  endDate: "",
  doctorCode: "",
  searchType: "",
  keyword: ""
};

function loadPatientList(page) {
  var params = $.extend({}, currentFilter, {
    cmd: "patientListModal",
    page: page,
    pageSize: pageSize
  });
  $.ajax({
    url: "controller",
    type: "GET",
    data: params,
    dataType: "json",
    success: function(data) {
      var list = data.list || [];
      var totalCount = data.totalCount || 0;
      if (totalCount === 0) {
        totalPages = 0;
        currentPage = 1;
        renderTable([]);
        renderPager(0);
        return;
      }
      totalPages = Math.ceil(totalCount / pageSize);
      currentPage = page;
      renderTable(list);
      renderPager(totalCount);
    },
    error: function() {
      showAlert("환자 목록을 불러오는 중 오류가 발생했습니다.");
    }
  });
}

function validateDates() {
  var start = $("#startDate").val();
  var end   = $("#endDate").val();
  if (start && end && start > end) {
    end = start;
    $("#endDate").val(start);
  }
  if (start || end) loadDoctorList(start, end);
  currentFilter = {
    startDate: start || "",
    endDate: end || "",
    doctorCode: $("#doctorSelect").val() || "",
    searchType: $("#searchType").val() || "",
    keyword: $("#keyword").val().trim() || ""
  };
  loadPatientList(1);
  return true;
}

  $("#searchBtn").click(function() {
    currentFilter = {
      startDate: $("#startDate").val(),
      endDate: $("#endDate").val(),
      doctorCode: $("#doctorSelect").val(),
      searchType: $("#searchType").val(),
      keyword: $("#keyword").val().trim()
    };
    loadPatientList(1);
  });
  
  $("#keyword").keypress(function(e) {
	    if (e.key === "Enter") $("#searchBtn").click();
  });

  $("#startDate, #endDate, #doctorSelect").change(validateDates);
 
  //선택한 수신자들을 여기 보관
  let selectedIds = [];
  let selectedRecipients = [];
  
  $("#sendCommonSMSSelectBtn").click(function () {
	  const ids = [];
	  $("#patientTableBody .row-check:checked").each(function () {
	    ids.push($(this).closest("tr").children().eq(1).text().trim()); // 두번째 칸: 환자등록번호
	  });
	  if (ids.length === 0) {
	    showAlert("선택된 환자가 없습니다.");
	    return;
	  }

	  $.ajax({
	    url: "controller?cmd=getCommonRecipient",
	    type: "POST",
	    data: { patientNo: ids },
	    traditional: true,   // 배열 전송
	    dataType: "json",
	    success: function (list) {
	      const $tbody = $("#recipientTableBody").empty();

	      if (!Array.isArray(list) || list.length === 0) {
	        $("#recipientCount").text("수신자 : 0명");
	        return;
	      }
	      
	      // ✅ 전역 보관
	      selectedIds = ids.slice(); // 복사 저장
	      // 응답 VO에 patientNo가 없으면, ids 순서대로 매칭
	      selectedRecipients = list.map(r => ({
	        patientNo: r.patientNo || "",
	        patientName: r.patientName || "",
	        phone: r.phone || ""
	      }));

	      list.forEach(r => {
	        $tbody.append(`
	          <tr>
	            <td style="border:none; background: transparent;">${r.patientName || ""}</td>
	            <td style="border:none; background: transparent;">${r.phone || ""}</td>
	          </tr>
	        `);
	      });

	      $("#recipientCount").text(`수신자 : ${list.length}명`);
	    },
	    error: function () {
	      showAlert("전송 중 오류가 발생했습니다.");
	    }
	  });
	});

  $("#sendReserveSMSSelectBtn").click(function () {
	  const ids = [];
	  $("#reserveTable tbody .row-check:checked").each(function () {
		  const rno = $(this).closest("tr").data("reserve-no");
		  if (rno) ids.push(rno);
		  });
	  if (ids.length === 0) {
	    showAlert("선택된 예약이 없습니다.");
	    return;
	  }

	  $.ajax({
	    url: "controller?cmd=getReserveRecipient",
	    type: "POST",
	    data: { reserveNo: ids },
	    traditional: true,   // 배열 전송
	    dataType: "json",
	    success: function (list) {
	      const $tbody = $("#reserveRecipientTableBody").empty();

	      if (!Array.isArray(list) || list.length === 0) {
	        $("#reserveRecipientCount").text("수신자 : 0명");
	        return;
	      }
	      
	      // ✅ 전역 보관
	      selectedIds = ids.slice(); // 복사 저장
	      // 응답 VO에 patientNo가 없으면, ids 순서대로 매칭
	      selectedRecipients = list.map(r => ({
	        reserveNo: r.reserveNo || "",
	        patientName: r.patientName || "",
	        phone: r.phone || ""
	      }));

	      list.forEach(r => {
	        $tbody.append(`
	          <tr>
	            <td style="border:none; background: transparent;">${r.patientName || ""}</td>
	            <td style="border:none; background: transparent;">${r.phone || ""}</td>
	          </tr>
	        `);
	      });

	      $("#reserveRecipientCount").text(`수신자 : ${list.length}명`);
	    },
	    error: function () {
	      showAlert("전송 중 오류가 발생했습니다.");
	    }
	  });
	});

  function loadDoctorList(startDate, endDate) {
	  var prevValue = $("#doctorSelect").val();
	  $.ajax({
	    url: "controller",
	    type: "GET",
	    data: { cmd: "getDoctorListByDateAction", startDate: startDate, endDate: endDate },
	    dataType: "json",
	    success: function(list) {
	      var $doctorSelect = $("#doctorSelect");
	      $doctorSelect.empty().append('<option value="">담당 의사 선택</option>');
	      $.each(list, function(i, d) {
	        var code = d.doctorCode ? d.doctorCode : "";
	        var opt = '<option value="' + code + '">' +
	                   d.employeeName + ' (' + d.department + ', ' + code + ')' +
	                   '</option>';
	        $doctorSelect.append(opt);
	      });
	      if ($doctorSelect.find("option[value='" + prevValue + "']").length > 0)
	        $doctorSelect.val(prevValue);
	      else $doctorSelect.val("");
	      $doctorSelect.prop("disabled", false);
	    },
	    error: function() {
	      showAlert("의사 목록을 불러오는 중 오류가 발생했습니다.");
	    }
	  });
	}
  
  
  
  loadDoctorList($("#startDate").val() || "", $("#endDate").val() || "");
  loadPatientList(1);

	  


	document.getElementById("commonSMSRecord").addEventListener("click", () => {
		  window.location.href = "controller?cmd=SMSRecordUI&tab=common";
		});
	
	document.addEventListener("DOMContentLoaded", function () {
	  const params = new URLSearchParams(window.location.search);

	  if (params.get("tab") === "common") {
	    commonBtn.click();

	    const stored = sessionStorage.getItem("selectedPatientNos");
	    if (!stored) return;

	    const ids = JSON.parse(stored);

	    $.ajax({
	      url: "controller?cmd=getCommonRecipient",
	      type: "POST",
	      data: { patientNo: ids },
	      traditional: true,
	      dataType: "json",
	      success: function (list) {
	        const $tbody = $("#recipientTableBody").empty();

	        if (!Array.isArray(list) || list.length === 0) {
	          $("#recipientCount").text("수신자 : 0명");
	          return;
	        }
	        
	        selectedRecipients = list.map(r => ({
	            patientNo: r.patientNo || "",
	            patientName: r.patientName || "",
	            phone: r.phone || ""
	          }));

	        list.forEach(r => {
	          $tbody.append(`
	            <tr>
	              <td style="border:none; background: transparent;">${r.patientName || ""}</td>
	              <td style="border:none; background: transparent;">${r.phone || ""}</td>
	            </tr>
	          `);
	        });

	        $("#recipientCount").text(`수신자 : ${list.length}명`);
	      },
	      complete: function () {
	        sessionStorage.removeItem("selectedPatientNos");
	      },
	      error: function () {
	        showAlert("전송 중 오류가 발생했습니다.");
	      }
	    });
	  }
	});
	
	
</script>


</body>
</html>
