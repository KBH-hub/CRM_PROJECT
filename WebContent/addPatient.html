<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>환자 등록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <main class="col-10 p-4">
      <div class="container-fluid bg-white border rounded shadow-sm p-4">

        <h4 class="text-center fw-bold mb-4 text-primary">환자 등록</h4>

        <table class="table table-bordered align-middle mb-4">
          <tbody>
            <tr>
              <th class="table-secondary text-center">등록번호</th>
              <td><input id="patientNo" type="text" class="form-control" disabled></td>
              <th class="table-secondary text-center">이름</th>
              <td><input id="patientName" type="text" class="form-control" placeholder="예: 홍길동" required></td>
              <th class="table-secondary text-center">전화번호</th>
              <td><input id="phone" type="tel" class="form-control" placeholder="010-1234-5678" required></td>
            </tr>
            <tr>
              <th class="table-secondary text-center">주소</th>
              <td colspan="3"><input id="address" type="text" class="form-control" disabled></td>
              <th class="table-secondary text-center">등록일</th>
              <td><input id="inDate" type="date" class="form-control" disabled></td>
            </tr>
            <tr>
              <th class="table-secondary text-center">생년월일</th>
              <td><input id="birth" type="text" class="form-control" disabled></td>
              <th class="table-secondary text-center">성별</th>
              <td>
                <select id="gender" class="form-select" disabled>
                  <option value="">선택</option>
                  <option>남</option>
                  <option>여</option>
                </select>
              </td>
              <th class="table-secondary text-center">내원경로</th>
              <td><input id="path" type="text" class="form-control" disabled></td>
            </tr>
            <tr>
              <th class="table-secondary text-center">진료과</th>
              <td><input id="department" type="text" class="form-control" disabled></td>
              <th class="table-secondary text-center">담당의사</th>
              <td><input id="employeeName" type="text" class="form-control" disabled></td>
              <th class="table-secondary text-center">입원여부</th>
              <td><input id="status" type="text" class="form-control" disabled></td>
            </tr>
          </tbody>
        </table>

        <h4 class="text-center text-white bg-secondary py-2 rounded">진료 기록</h4>
        <div class="row mt-3">
          <div class="col-3">
            <ul class="list-group" id="medicalList">
              <li class="list-group-item text-center text-muted">등록 후 진료 시 기록이 생성됩니다.</li>
            </ul>
          </div>
          <div class="col-9">
            <div class="border rounded p-3 bg-light" id="medicalDetail">
              <p class="text-muted text-center">진료 기록이 없습니다.</p>
            </div>
          </div>
        </div>

        <div class="text-end mt-4">
          <button class="btn btn-primary px-4" id="registerBtn">등록</button>
          <button class="btn btn-secondary px-4" onclick="history.back()">취소</button>
        </div>

        <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center border border-primary">
              <div class="modal-body">
                <p id="alertMessage" class="fs-5 fw-bold mb-4 text-dark"></p>
                <div class="d-flex justify-content-center">
                  <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">확인</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function loadSidebar(activeKey) {
  $.ajax({
    url: "./sidebar.html",
    dataType: "html",
    success: function (html) {
      $("#sidebar-slot").html(html);

      var $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
      $links.removeClass("active bg-primary text-white").addClass("text-dark");

      var $current = $links.filter("[data-route='" + activeKey + "']");
      $current.addClass("active bg-primary text-white").removeClass("text-dark");
    },
    error: function () {
      console.error("사이드바 로드 실패");
    }
  });
}
loadSidebar("patientList");

function showAlert(message, onClose) {
  $("#alertMessage").text(message);
  var modal = new bootstrap.Modal(document.getElementById("alertModal"));
  $("#alertModal").on("hidden.bs.modal", function handler() {
    if (typeof onClose === "function") onClose();
    $("#alertModal").off("hidden.bs.modal", handler);
  });
  modal.show();
}

$("#registerBtn").on("click", function() {
  var name = $("#patientName").val().trim();
  var phone = $("#phone").val().trim();

  if (!name || !phone) {
    showAlert("이름과 전화번호를 입력하세요.");
    return;
  }

  $.ajax({
    url: "controller",
    type: "POST",
    data: {
      cmd: "addPatientAction",
      patientName: name,
      phone: phone
    },
    dataType: "json",
    success: function(data) {
      if (data.result === "success") {
        showAlert("환자 등록이 완료되었습니다.", function() {
          window.location.href = "controller?cmd=patientInfoUI&patientNo=" + data.patientNo;
        });
      } else {
        showAlert("등록 실패");
      }
    },
    error: function(xhr, status, err) {
      console.error("등록 중 오류:", err);
      showAlert("등록 중 오류가 발생했습니다.");
    }
  });
});
</script>
</body>
</html>
