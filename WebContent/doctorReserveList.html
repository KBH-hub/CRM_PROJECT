<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>예약 달력-의사</title>

  <!-- ✅ Bootstrap 5.3.0 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <style>
    /* ✅ 테이블 전체 선 검정색 */
    table, th, td {
      border-collapse: collapse;
    }


    #container {
      margin-top: 20px;
    }

    .calendar-controls {
      display: flex;
      flex-direction: column; /* 위아래 배치 */
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* ✅ 날짜를 오른쪽 상단으로 정렬 */
    .month-view td {
      position: relative;
      height: 80px;
      vertical-align: top !important;
    }
    .month-view td strong {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 0.9rem;
    }
    .month-view td small {
      display: block;
      margin-top: 22px;
      font-size: 0.75rem;
      color: #555;
    }

    /* ✅ 주간 / 일간 달력의 표 높이 축소 */
    .week-view td,
    .day-view td {
      height: 36px;
      padding: 4px 6px !important;
      font-size: 0.85rem;
      vertical-align: middle !important;
    }
    /* Day 뷰 컨테이너 */
.day-view-grid {
    border: 1px solid #dee2e6; /* 테이블 테두리처럼 보이게 */
    border-radius: 0.375rem; /* Bootstrap 기본 라운드 코너 */
    overflow: hidden; /* 내부 요소가 넘치지 않도록 */
    background-color: #fff; /* 배경색 */
}

/* 시간 축 */
.time-axis {
    flex-shrink: 0; /* 크기가 줄어들지 않도록 */
    background-color: #f8f9fa; /* 배경색 */
    padding-top: 2px; /* 위쪽 여백 */
}

.time-label {
    height: 60px; /* 각 시간 블록의 높이 (스크린샷 기준) */
    line-height: 60px; /* 텍스트 수직 중앙 정렬 */
    font-weight: bold;
    font-size: 0.9rem;
    color: #495057;
    border-bottom: 1px solid #dee2e6; /* 시간 레이블 아래 구분선 */
}
.time-label:last-child {
    border-bottom: none; /* 마지막 시간 레이블은 아래 구분선 제거 */
}

/* 예약 내용 영역 */
.reservation-content {
    background-color: #fff; /* 배경색 */
    padding-left: 5px; /* 왼쪽 여백 */
    padding-right: 5px; /* 오른쪽 여백 */
}

.hour-slot {
    height: 60px; /* time-label과 동일하게 설정 */
    display: flex; /* 예약 블록들을 가로로 배치 */
    align-content: flex-start; /* 예약 블록들이 위에서부터 채워지도록 */
    border-bottom: 1px solid #dee2e6; /* 각 시간 슬롯 아래 구분선 */
    flex-direction: column;
}
.hour-slot:last-child {
    border-bottom: none !important; /* 마지막 시간 슬롯은 아래 구분선 제거 */
}

.reservation-block {
    font-size: 0.75rem; /* 예약 블록 텍스트 크기 */
    white-space: nowrap; /* 텍스트 줄바꿈 방지 */
    overflow: hidden; /* 넘치는 텍스트 숨김 */
    text-overflow: ellipsis; /* 넘치는 텍스트 ... 처리 */
    flex-grow: 1;
    max-width: 100%; /* 부모 너비를 넘지 않도록 */
    height: fit-content%; /* 내용에 맞춰 높이 조절 */
    /* 스크린샷의 색상들을 반영하여 여러 스타일 클래스 추가 가능 */
    /* 예: text-bg-primary, text-bg-success, text-bg-warning 등 */
    /* 지금은 text-bg-primary로 통일합니다. */
}
/* 시간대별 배치 */
.reservation-block[data-time$=":00"] {
  top: 0; /* 위쪽 절반 */
}

.reservation-block[data-time$=":30"] {
  bottom: 0; /* 아래쪽 절반 */
}
.week-view .reservation-block {
  font-size: 0.7rem;
  margin: 2px;
  display: block; /* 위아래 배치 */
}

/* 스크린샷처럼 여러 색상을 사용하고 싶다면, 백엔드에서 예약마다 색상 관련 필드를 추가하거나,
   진료과 등에 따라 동적으로 클래스를 부여하는 로직이 필요합니다. */
.reservation-block.bg-success { background-color: #198754 !important; }
.reservation-block.bg-info { background-color: #0dcaf0 !important; }
.reservation-block.bg-warning { background-color: #ffc107 !important; }
/* 등등... */
  </style>
</head>

<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">

    <!-- 여기서 사이드바를 주입 -->
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <!-- 메인 -->
    <main class="col-10 p-4">
  <div class="container py-4">
    <h2 class="text-center mb-4">예약 달력-의사</h2>

    <div class="calendar-controls">
      <!-- ✅ 드롭다운 -->
      <div class="d-inline-flex align-items-center">
        <label for="viewSelect" class="me-2 mb-0 fw-bold">월/주/일 선택</label>
        <select id="viewSelect" class="form-select form-select-sm w-auto">
          <option value="month" selected>Month</option>
          <option value="week">Week</option>
          <option value="day">Day</option>
        </select>
      </div>

      <!-- ✅ 이전/다음 버튼 -->
      <div>
        <button id="prev" class="btn btn-outline-dark">◀</button>
        <span id="ym" class="fw-bold fs-5">—</span>
        <button id="next" class="btn btn-outline-dark">▶</button>
      </div>
    </div>

    <div id="container"></div>
  </div>
  <!-- ✅ 예약 버튼 영역 -->
<div class="d-flex justify-content-end gap-2 mt-4 pe-4">
  <!-- 내 예약 목록 버튼 -->
  <button id = "openListBtn"
  		  class="btn btn-outline-primary px-4">
    예약 목록
  </button>
</div>


<!-- ✅ 내 예약 목록 모달 -->
<div class="modal fade" id="myReserveListModal" tabindex="-1"
		aria-hidden="true">
		<div
			class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content custom-modal-size">

				<div class="modal-header">
					<div class="d-flex gap-2">
						<h5 class="modal-title fw-bold">전체 예약 목록</h5>
					</div>
					<div>
						<button class="btn btn-primary" data-bs-dismiss="modal">닫기</button>
					</div>
				</div>

				<div class="modal-body">
					<div class="row mb-3">
						<div class="row g-3 mb-3 align-items-end">
							<div class="col-md-3">
								<label class="form-label">월</label> <input type="month"
									id="filterMonth" class="form-control">
							</div>
							<div class="col-md-3">
								<label class="form-label">주(월~일)</label> <select id="filterWeek"
									class="form-select">
									<option value="">주 선택</option>
									<!-- JS가 9월 15일 - 9월 21일 형식 옵션 자동 생성 -->
								</select> <input type="hidden" id="filterWeekStart"> <input
									type="hidden" id="filterWeekEnd">
							</div>
							<!-- 일 -->
							<div class="col-md-3">
								<label class="form-label">일</label> <select id="filterDay"
									class="form-select" disabled>
									<option value="">주를 먼저 선택하세요</option>
								</select>
							</div>
							<div class="col-md-3">
								<label class="form-label">시간</label> <select id="filterHour"
									class="form-select" disabled>
									<option value="">전체</option>
									<option value="07">07시</option>
									<option value="08">08시</option>
									<option value="09">09시</option>
									<option value="10">10시</option>
									<option value="11">11시</option>
									<option value="12">12시</option>
									<option value="13">13시</option>
									<option value="14">14시</option>
									<option value="15">15시</option>
									<option value="16">16시</option>
									<option value="17">17시</option>
									<option value="18">18시</option>
									<option value="19">19시</option>
								</select>
							</div>
						</div>

						<div class="table-responsive">
							<table id="reserveTable"
								class="table table-bordered text-center align-middle">
								<thead class="table-light">
									<tr>
										<th scope="col"><input type="checkbox" class="selectAll"></th>
										<th scope="col">이름</th>
										<th scope="col">방문 예정 일</th>
										<th scope="col">방문 예정 시간</th>
										<th scope="col">담당의사</th>
										<th scope="col">진료과</th>
										<th scope="col">상세</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="7" class="text-muted">검색 결과가 없습니다.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>


				</div>
				<div class="modal-footer d-flex justify-content-between">
					<div class="d-flex gap-2">
						<button id="sendReserveSMSSelectBtn" class="btn btn-primary"
							data-bs-dismiss="modal">선택 메시지 보내기</button>
						<button id="deleteReserveSelectBtn" class="btn btn-primary"
							data-bs-dismiss="modal">선택 예약 삭제</button>
					</div>
				</div>
			</div>
		</div>
		</div>


<!-- ✅ Bootstrap JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="sidebar.js"></script>
<script src="sidebarReserve.js"></script>
<script src="sidebarMyReserve.js"></script>

	</main>
		</div>
	</div>
	<script>
	  // sidebar.html을 불러와서 #sidebar-slot에 삽입
	  function loadSidebar(activeKey) {
		  $.ajax({
		    url: "./doctorSidebar.html",
		    dataType: "html",
		    success: function (html) {
		      $("#sidebar-slot").html(html);
		      var $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
		      $links.removeClass("active bg-primary text-white").addClass("text-dark");
		      var $current = $links.filter("[data-route='" + activeKey + "']");
		      $current.addClass("active bg-primary text-white").removeClass("text-dark");
		      loadSidebarInfo();
		      loadSidebarReserve();
		      loadSidebarMyReserve();
		    }
		  });
		}
		loadSidebar("reserve");

		
		const container = document.getElementById('container');
		const ymSpan = document.getElementById('ym');
		//const reservationEvents = {
		//  "2025-09-16": [
//		    { start: "09:00", end: "09:30", title: "고은님 9:00" },
//		    { start: "14:00", end: "14:30", title: "이수현 14:00" }
		//  ],
		//  "2025-09-15": [
//		    { start: "10:00", end: "11:00", title: "심박 검사" }
		 // ]
		//};
		// 서버에서 받아온 일별 총 예약 건수 데이터를 저장할 변수
		// [{DAY_OF_MONTH: "01", TOTAL_COUNT: 5}, {DAY_OF_MONTH: "02", TOTAL_COUNT: 3}, ...]
		let fetchedDailyReservationCounts = []; 

		let viewMode='month', viewDate=new Date(); viewDate.setDate(1);
		const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
		const addDays=(d,n)=>{const t=new Date(d);t.setDate(t.getDate()+n);return t;};

		//아래는 week 날짜 계산하는 것
		const startOfWeekMonday=d=>{const t=new Date(d);const day=t.getDay();const diff=(day===0?-6:1-day);t.setDate(t.getDate()+diff);return t;};


		async function fetchAndRenderCalendarData() {
		    const year = viewDate.getFullYear();
		    const month = (viewDate.getMonth() + 1).toString().padStart(2, '0');
		    const monthStr = `${year}-${month}`; 

		    
		    let apiUrl = ''; 
		    let params = ''; 
		    
		    
		    
		    if (viewMode === 'month'){
		        apiUrl = 'controller?cmd=countMyReserveMonth';
		        params = `&month=${monthStr}`; 
		    } else if (viewMode === 'week') { 
		        apiUrl = 'controller?cmd=countMyReserveWeek';
		        const monday = startOfWeekMonday(viewDate);
		        const sunday = addDays(monday, 6); 
		        const weekMonthStr = `${monday.getFullYear()}-${String(monday.getMonth() + 1).padStart(2, '0')}`;
		        params = `&month=${weekMonthStr}&startDate=${fmt(monday)}&endDate=${fmt(sunday)}`; 
		    } else if (viewMode === 'day') {
		        apiUrl = 'controller?cmd=getMyReserveList';
		        params = `&targetDate=${fmt(viewDate)}`; 
		    }
		    
		    
		    
		    try {
		        
		        const response = await fetch(`${apiUrl}${params}`);
		        
		        if (!response.ok) {
		            throw new Error(`HTTP error! status: ${response.status}`);
		        }
		        
		       
		        const data = await response.json(); 
		       

		       
		        fetchedDailyReservationCounts = data; 
		        
		       
		        render();

		    } catch (error) {
		        console.error('캘린더 데이터를 가져오는 중 오류 발생:', error);
		        alert('예약 데이터를 불러오지 못했습니다. 다시 시도해 주세요.');
		     
		        container.innerHTML = '<p class="text-danger">예약 데이터를 불러오는 데 실패했습니다.</p>';
		    }
		}


		//---------- 캘린더 렌더 ----------
		function render(){
		  if(viewMode==='month') renderMonth();
		  else if(viewMode==='week') renderWeek();
		  else renderDay();
		}

		function renderMonth(){
		  const y=viewDate.getFullYear(), m=viewDate.getMonth();
		  ymSpan.textContent=`${y}년 ${m+1}월`; 
		  

		  const dailyCountsMap = new Map();
		  if (Array.isArray(fetchedDailyReservationCounts)) {
		      fetchedDailyReservationCounts.forEach(item => {
		        
		          dailyCountsMap.set(parseInt(item.reserveDay.split('-')[2]), item.reserveCount); 
		      });
		  }

		  let first=new Date(y,m,1).getDay(); 
		  if(first===0) first=7; 
		  const days=new Date(y,m+1,0).getDate();
		  const wd=['일','월','화','수','목','금','토']; 
		  let html='<table class="table table-bordered text-center align-middle month-view"><thead><tr>';
		  wd.forEach(d=>html+=`<th>${d}</th>`); 
		  html+='</tr></thead><tbody>';

		  let day=1;
		  let started = false;

		  for(let r=0;r<6&&day<=days;r++){ 
		    html+='<tr>';
		    for(let c=0;c<7;c++){ 
		        
		        if(!started && c < new Date(y,m,1).getDay()) { 
		          html+='<td></td>';
		        } else if (day > days) { 
		          html+='<td></td>';
		        } else {
		            const totalCount = dailyCountsMap.get(day) || 0; // 해당 일자의 예약 건수, 없으면 0
		            const isToday = (new Date().getFullYear() === y && new Date().getMonth() === m && new Date().getDate() === day);
		            const tdClass = (c === 0 || c === 6) ? 'weekend' : ''; // 일요일(0) 또는 토요일(6)은 주말
		            
		            html+=`<td class="${tdClass} ${isToday ? 'today' : ''}"><strong>${day}</strong><small>총 예약 ${totalCount}건</small></td>`;
		            day++; 
		            started=true;
		        }
		    }
		    html+='</tr>';
		  }
		  html+='</tbody></table>';
		  container.innerHTML=html;
		}

		function renderWeek() {
			  const mon = startOfWeekMonday(viewDate);
			  const weekDays = [...Array(7)].map((_, i) => addDays(mon, i));
			  ymSpan.textContent = `${fmt(weekDays[0])} ~ ${fmt(weekDays[6])}`;

			  const hours = [...Array(13)].map((_, i) => i + 7); // 07~19시

			  let html = '<table class="table table-bordered text-center align-middle week-view"><thead><tr><th>시간</th>';
			  weekDays.forEach(d => {
			    const headerDate = (d.getMonth() + 1) + '/' + d.getDate();
			    const dayName = d.toLocaleDateString('ko-KR', { weekday: 'short' });
			    html += `<th>${dayName} (${headerDate})</th>`;
			  });
			  html += '</tr></thead><tbody>';

			  // ✅ 시간별로 렌더링
			  hours.forEach(h => {
			    const hourKey = String(h).padStart(2, '0');
			    html += `<tr><td>${hourKey}:00</td>`;

			    weekDays.forEach(d => {
			      const dayKey = fmt(d);
			      const reservationsInHour = fetchedDailyReservationCounts.filter(
			        item => item.reserveDay === dayKey && item.reserveTime.startsWith(hourKey)
			      );

			      html += `<td>`;
			      if (reservationsInHour.length > 0) {
			        reservationsInHour.sort((a, b) => a.reserveTime.localeCompare(b.reserveTime));
			        reservationsInHour.forEach(res => {
			          const bgColorClass = 'text-bg-secondary';
			          const displayTime = res.reserveTime.substring(0, 5);
			          html += `
			            <div class="reservation-block badge ${bgColorClass} m-1"
			                 data-time="${displayTime}"
			                 title="${res.department} ${res.employeeName}">
			                 ${res.patientName} 님 ${displayTime}
			            </div>`;
			        });
			      }
			      html += `</td>`;
			    });

			    html += '</tr>';
			  });

			  html += '</tbody></table>';
			  container.innerHTML = html;
			}


		function renderDay(){
		    const currentDay = viewDate;
		    ymSpan.textContent = fmt(currentDay); // 상단에 "2025-09-16" 표시

		    const dayName = currentDay.toLocaleDateString('ko-KR', { weekday: 'long' });

		    const hourlyReservationsMap = new Map();
		    const currentDayKey = fmt(currentDay); // 현재 선택된 날짜의 키 생성

		    if (Array.isArray(fetchedDailyReservationCounts)) {
		        fetchedDailyReservationCounts.forEach(item => {
		            // 현재 날짜와 일치하는 예약만 필터링
		            if (item.reserveDay === currentDayKey) {
		                const hour = item.reserveTime ? item.reserveTime.substring(0, 2) : '00';
		                const mapKey = `${currentDayKey}_${hour}`; // 현재 날짜와 시간으로 mapKey 생성
		                const reservations = hourlyReservationsMap.get(mapKey) || [];
		                reservations.push(item);
		                hourlyReservationsMap.set(mapKey, reservations);
		            }
		        });
		    }

		    const hours = [...Array(13)].map((_, i) => i + 7);

		    let html = `
		        <div class="d-flex flex-column align-items-center mb-3">
		            <h3 class="fw-bold">${dayName}</h3>
		        </div>
		        <div class="day-view-grid d-flex">
		            <div class="time-axis" style="width: 80px; text-align: right; padding-right: 10px;">
		    `;
		    hours.forEach(h => {
		        html += `<div class="time-label" style="height: 60px; line-height: 60px;">${String(h).padStart(2, '0')}:00</div>`;
		    });
		    html += `
		            </div>
		            <div class="reservation-content flex-grow-1 border-start">
		    `;

		    hours.forEach(h => {
		        const hourKey = String(h).padStart(2, '0');
		        const fullKey = `${currentDayKey}_${hourKey}`; // 현재 날짜와 시간으로 fullKey 생성

		        const reservationsInHour = hourlyReservationsMap.get(fullKey) || [];

		        html += `
		            <div class="hour-slot">
		        `;
		        
		        reservationsInHour.sort((a, b) => {
		            // reserveTime이 "HH:MM" 형식이라고 가정
		            return a.reserveTime.localeCompare(b.reserveTime);
		        });

		        reservationsInHour.forEach(res => {
		            const bgColorClass = 'text-bg-secondary';
		            const displayTime = res.reserveTime ? res.reserveTime.substring(0, 5) : '';
		            const blockText = `${res.patientName} 님  ${displayTime}`;
		            const tooltipText = `${res.patientName} 님 (${displayTime})  ${res.department}  ${res.employeeName} 진료 예약`;

		            html += `
		                <div class="reservation-block badge ${bgColorClass} m-1"
		                     data-bs-toggle="tooltip" data-bs-placement="top"
		                     title="${tooltipText}"
		                     data-reserve-no="${res.reserveNo || ''}">
		                     ${blockText}
		                </div>
		            `;
		        });

		        html += `
		            </div>
		        `;
		    });

		    html += `
		            </div>
		        </div>
		    `;

		    container.innerHTML = html;

		    // ⭐ 툴팁 초기화: DOM이 업데이트된 후 호출 ⭐
		    initTooltips();
		}

		// ⭐ 툴팁 초기화 함수 분리 ⭐
		function initTooltips() {
		    // 기존 툴팁 인스턴스가 있다면 파괴 (메모리 누수 방지)
		    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipEl => {
		        const tooltip = bootstrap.Tooltip.getInstance(tooltipEl);
		        if (tooltip) {
		            tooltip.dispose();
		        }
		    });
		    // 새로운 툴팁 인스턴스 생성
		    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
		        return new bootstrap.Tooltip(tooltipTriggerEl);
		    });
		}

		// ✅ 이벤트 핸들러 변경: render() 대신 fetchAndRenderCalendarData() 호출
		document.getElementById('viewSelect').addEventListener('change', e => { 
		    viewMode = e.target.value; 
		    fetchAndRenderCalendarData(); 
		});

		document.getElementById('prev').onclick = () => { 
		    if(viewMode === 'month') viewDate.setMonth(viewDate.getMonth() - 1);
		    else if(viewMode === 'week') viewDate.setDate(viewDate.getDate() - 7);
		    else viewDate.setDate(viewDate.getDate() - 1);
		    fetchAndRenderCalendarData(); // 데이터 다시 가져오기
		};

		document.getElementById('next').onclick = () => { 
		    if(viewMode === 'month') viewDate.setMonth(viewDate.getMonth() + 1);
		    else if(viewMode === 'week') viewDate.setDate(viewDate.getDate() + 7);
		    else viewDate.setDate(viewDate.getDate() + 1);
		    fetchAndRenderCalendarData(); // 데이터 다시 가져오기
		};

		// ✅ 페이지 로드 시 초기 캘린더 데이터를 가져옵니다.
		fetchAndRenderCalendarData();
		
		// ---------- 예약 목록 모달----------

		let managerModalInited = false;
		let suppressAutoInit = false;

		(function(){
			  const table = document.getElementById('reserveTable');
			  const selectAll = table.querySelector('thead .selectAll');
			  const tbody = table.querySelector('tbody');

			  // 헤더 전체선택 클릭 -> 현재 tbody의 모든 row-check 상태 일괄 변경
			  if (selectAll) {
			    selectAll.addEventListener('change', () => {
			      const checks = tbody.querySelectorAll('.row-check');
			      checks.forEach(c => c.checked = selectAll.checked);
			    });
			  }
			  
			  
		    // ✅ 예약 목록 테이블의 상세 버튼 클릭 이벤트 수정
		    document.getElementById('reserveTable').addEventListener('click', async e => {
		        const btn = e.target.closest('.detail-btn');
		        if (!btn) return;

		        const tr = btn.closest('tr');
		        const reserveNo = tr.dataset.reserveNo; // tr에 설정된 data-reserve-no 값 가져오기

		        if (!reserveNo) {
		            alert('예약 번호를 찾을 수 없습니다.');
		            return;
		        }

		        try {
		            // 서버에 예약 상세 정보 요청
		            const response = await fetch(`controller?cmd=getReserveDetail&reserveNo=${reserveNo}`);
		            if (!response.ok) {
		                throw new Error(`HTTP error! status: ${response.status}`);
		            }
		            const data = await response.json(); // JSON 응답 파싱

		            // 현재 열려있는 '전체 예약 목록' 모달 숨기기 전에 스택에 저장
		            const myReserveListModal = document.getElementById("myReserveListModal");
		            if (myReserveListModal && bootstrap.Modal.getInstance(myReserveListModal) && bootstrap.Modal.getInstance(myReserveListModal)._isShown) {
		                modalStack.push(myReserveListModal.id);
		                toggleModal(myReserveListModal.id, false);
		            }

		            fillReservationDetailModal(data); // 상세 모달에 데이터 채우고 열기

		        } catch (error) {
		            console.error('예약 상세 정보를 가져오는 중 오류 발생:', error);
		            alert('예약 상세 정보를 불러오지 못했습니다. 다시 시도해 주세요.');
		        }
		    });
		})(); 

		// ===== 유틸 =====
		const addDay = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
		const ymd = d => { const t=new Date(d.getTime()); const Y=t.getFullYear(), M=String(t.getMonth()+1).padStart(2,'0'), D=String(t.getDate()).padStart(2,'0'); return `${Y}-${M}-${D}`; };
		const formatKo = d => `${d.getMonth()+1}월 ${d.getDate()}일`;
		const getMonday = d => { const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; };

		// 월의 주(월~일) 목록 만들기
		function buildWeeksForMonth(year, month){
		  const first = new Date(year, month-1, 1);
		  const last  = new Date(year, month, 0);
		  let curMon  = getMonday(first);
		  const weeks = [];
		  while (curMon <= last){
		    const start = new Date(curMon), end = addDay(start, 6);
		    weeks.push({ start, end });
		    curMon = addDay(curMon, 7);
		  }
		  return weeks;
		}

		// 주 셀렉트 옵션 렌더 (선택은 하지 않음 → 사용자가 직접 고르게)
		function renderWeekOptions(year, month){
		  const $sel = $('#filterWeek').empty().append('<option value="">주 선택</option>');
		  buildWeeksForMonth(year, month).forEach(({start, end})=>{
		    const val = `${ymd(start)}|${ymd(end)}`;
		    const label = `${formatKo(start)} - ${formatKo(end)}`;
		    $sel.append(new Option(label, val));
		  });

		  // 주를 강제로 자동 선택하지 않음 → day는 계속 disabled 상태 유지
		  $('#filterWeekStart, #filterWeekEnd').val('');
		  $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
		}

		// 선택된 주의 7일을 day 옵션으로 렌더
		function renderDayOptionsByWeek(){
		  const ws = $('#filterWeekStart').val(), we = $('#filterWeekEnd').val();
		  const $day = $('#filterDay').empty();
		  if (!ws || !we){
		    $day.prop('disabled', true).append('<option value="">주를 먼저 선택하세요</option>');
		    return;
		  }
		  $day.prop('disabled', false).append(new Option('전체', ''));
		  const start = new Date(ws);
		  for (let i=0;i<7;i++){
		    const d = addDay(start, i);
		    $day.append(new Option(formatKo(d), ymd(d)));
		  }
		  // 기본은 '전체'
		  $day.val('');
		}

		// ===== 이벤트 바인딩 =====

		// 모달 열릴 때: 오늘 월 세팅 + 주 목록 생성(자동선택 안 함) + 기본 조회(주 조건 없이 오늘/시간만으로 조회 필요시 조정)
		document.getElementById('myReserveListModal')
		  .addEventListener('shown.bs.modal', () => {
			  if (suppressAutoInit) { suppressAutoInit = false; return; }
		      if (managerModalInited) return;
		      const today = new Date();
		      const yyyy  = today.getFullYear();
		      const mm    = String(today.getMonth()+1).padStart(2,'0');
		      $('#filterMonth').val(`${yyyy}-${mm}`);
		      $('#filterHour').val('').prop('disabled', true);
		      renderWeekOptions(yyyy, parseInt(mm,10));
		      loadReserveList();
		      managerModalInited = true;
		  });

		// 월 변경 → 주 옵션 재생성 + day 비활성화 + 즉시 조회
		$('#filterMonth').on('change', function(){
		  const v = $(this).val();
		  $('#filterHour').val('').prop('disabled', true);
		  if (!v){
		    $('#filterWeek').empty().append('<option value="">주 선택</option>');
		    $('#filterWeekStart,#filterWeekEnd').val('');
		    $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
		    loadReserveList();
		    return;
		  }
		  const [y, m] = v.split('-').map(Number);
		  renderWeekOptions(y, m);
		  loadReserveList();
		});

		// ✅ 주 선택 → hidden 세팅 + 7일 옵션 생성 + 즉시 조회
		$('#filterWeek').on('change', function(){
		  const val = $(this).val(); // "YYYY-MM-DD|YYYY-MM-DD" 또는 ""
		  $('#filterHour').val('').prop('disabled', true);
		  if (!val){
		    $('#filterWeekStart,#filterWeekEnd').val('');
		    $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
		    loadReserveList();
		    return;
		  }
		  const [ws, we] = val.split('|');
		  $('#filterWeekStart').val(ws);
		  $('#filterWeekEnd').val(we);
		  renderDayOptionsByWeek();
		  loadReserveList();
		});

		// 일 선택 - 주 선택시 가능
		$('#filterDay').on('change', function(){
		  const hasDay = (($(this).val() || '') !== '');
		  if (hasDay) {
		    $('#filterHour').prop('disabled', false);
		  } else {
		    $('#filterHour').val('').prop('disabled', true);
		  }
		  loadReserveList();
		});

		// 시간 선택 → 즉시 조회
		$('#filterHour').on('change', loadReserveList);


		// ===== 예약목록 조회 AJAX =====
		function loadReserveList(){
		  const params = {
		    month:     $('#filterMonth').val()     || '',
		    weekStart: $('#filterWeekStart').val() || '',
		    weekEnd:   $('#filterWeekEnd').val()   || '',
		    day:       $('#filterDay').prop('disabled') ? '' : ($('#filterDay').val() || ''), // 주 미선택 시 day는 비움
		    hour:      $('#filterHour').val()      || ''
		  };
		  $.ajax({
		    url: 'controller?cmd=getMyReserveListModal',
		    method: 'get',
		    dataType: 'json',
		    data: params,
		    success: renderReserveList,
		    error: () => $('#reserveTable tbody').html('<tr><td colspan="7" class="text-danger">불러오기 실패</td></tr>')
		  });
		}

		function renderReserveList(reserveList){
		  const $tbody = $('#reserveTable tbody').empty();
		  if (!reserveList || reserveList.length === 0){
		    $tbody.html('<tr><td colspan="7" class="text-muted">검색 결과가 없습니다.</td></tr>');
		    return;
		  }
		  reserveList.forEach(r=>{
			    const $tr = $('<tr>').attr('data-reserve-no', r.reserveNo || '');
			    // 체크박스 열
			    $tr.append('<td><input type="checkbox" class="row-check"></td>');
			    // 데이터 열들
			    $tr.append($('<td>').text(r.patientName  || ''));
			    $tr.append($('<td>').text(r.reserveDay   || ''));
			    $tr.append($('<td>').text(r.reserveTime  || ''));
			    $tr.append($('<td>').text(r.employeeName || ''));
			    $tr.append($('<td>').text(r.department   || ''));
			    $tr.append('<td><button type="button" class="btn btn-sm detail-btn"><img src="img/detail.png" alt="상세보기" width="24" height="24"></button></td>');
			    $tbody.append($tr);
			  });
		}

		//현재 뷰 기준으로 목록 열기
		function openReserveListForCurrentView() {
			  suppressAutoInit = true;   // 자동 초기화 막기

			  const d = new Date(viewDate);
			  const y = d.getFullYear();
			  const m = d.getMonth() + 1;

			  // 월 세팅 + 주 옵션 렌더
			  $('#filterMonth').val(`${y}-${String(m).padStart(2,'0')}`);
			  renderWeekOptions(y, m);

			  // 공통 초기화
			  $('#filterWeek').val('');
			  $('#filterWeekStart').val('');
			  $('#filterWeekEnd').val('');
			  $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
			  $('#filterHour').val('').prop('disabled', true);

			  if (viewMode === 'month') {
			    // month: month만 사용 (week/day/hour 비움)
			  } else if (viewMode === 'week') {
			    const mon = startOfWeekMonday(d);
			    const sun = addDays(mon, 6);
			    const val = `${ymd(mon)}|${ymd(sun)}`;

			    $('#filterWeek').val(val);
			    $('#filterWeekStart').val(ymd(mon));
			    $('#filterWeekEnd').val(ymd(sun));

			    $('#filterDay').prop('disabled', false)
			                   .empty()
			                   .append(new Option('전체',''));
			    for (let i=0;i<7;i++){
			      const dd = addDays(mon, i);
			      $('#filterDay').append(new Option(`${dd.getMonth()+1}월 ${dd.getDate()}일`, ymd(dd)));
			    }
			    $('#filterDay').val('');
			    $('#filterHour').val('').prop('disabled', true);
			  } else if (viewMode === 'day') {
			    const mon = startOfWeekMonday(d);
			    const sun = addDays(mon, 6);
			    const val = `${ymd(mon)}|${ymd(sun)}`;

			    $('#filterWeek').val(val);
			    $('#filterWeekStart').val(ymd(mon));
			    $('#filterWeekEnd').val(ymd(sun));

			    $('#filterDay').prop('disabled', false)
			                   .empty()
			                   .append(new Option('전체',''));
			    for (let i=0;i<7;i++){
			      const dd = addDays(mon, i);
			      $('#filterDay').append(new Option(`${dd.getMonth()+1}월 ${dd.getDate()}일`, ymd(dd)));
			    }
			    $('#filterDay').val(ymd(d));         // 현재 날짜 지정
			    $('#filterHour').prop('disabled', false).val(''); // 시간은 전체
			  }

			  loadReserveList();
			  const listEl = document.getElementById('myReserveListModal');
			  bootstrap.Modal.getOrCreateInstance(listEl).show();
			}

			// 버튼 클릭 시 우리가 세팅해서 열기
			document.getElementById('openListBtn').addEventListener('click', (e) => {
			  e.preventDefault(); // data-bs-toggle 기본동작 막기
			  openReserveListForCurrentView();
			});
  </script>
</body>
</html>
