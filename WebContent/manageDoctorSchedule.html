<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>의사 주간 근무표</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .table th {
    background-color: #f8f9fa;
    vertical-align: middle;
  }
  .circle {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #7ca7d8;
  }
  .week-range {
    font-weight: 600;
    text-align: center;
    width: 20%;
  }
  .dropdown-menu {
  width: 300px;
  border: 1px solid #ccc;
  padding: 3px;
}
  .dropdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
  }
  .dropdown-item span {
    width: 33%;
    text-align: left;
  }
  .dropdown-item span:nth-child(1) { width: 10px; }
  .dropdown-item span:nth-child(2) { width: 70px; }
  .dropdown-item span:nth-child(3) { width: 50px; }
  .dropdown-item:hover {
    background-color: #e9f1fa;
  }
</style>
</head>

<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <main class="col-10 p-4">
      <h2 id="title" class="mb-3 border-bottom pb-2">의사 주간 근무 표</h2>
      <div class="container-fluid bg-white border rounded shadow-sm p-4">
        <div class="mb-3 d-flex justify-content-end gap-2">
          <button class="btn btn-primary" id="selectDeleteBtn">선택 지우기</button>
          <button class="btn btn-primary" id="doctorListBtn">의사 명단</button>
          <button class="btn btn-danger" id="editBtn">편집하기</button>
        </div>

        <div class="d-flex justify-content-center align-items-center mb-3">
          <button id="prev" class="btn btn-outline-secondary btn-sm">◀</button>
          <div class="week-range"></div>
          <button id="next" class="btn btn-outline-secondary btn-sm">▶</button>
        </div>

        <table class="table table-bordered align-middle text-center">
          <thead>
            <tr class="date-header">
              <th rowspan="2" style="width:3%;"><input type="checkbox"></th>
              <th rowspan="2" style="width:10%;">이름</th>
              <th rowspan="2" style="width:15%;">진료과</th>
              <th colspan="2"></th>
              <th colspan="2"></th>
              <th colspan="2"></th>
              <th colspan="2"></th>
              <th colspan="2"></th>
              <th colspan="2"></th>
              <th colspan="2"></th>
            </tr>
            <tr class="table-light">
              <th>오전</th><th>오후</th>
              <th>오전</th><th>오후</th>
              <th>오전</th><th>오후</th>
              <th>오전</th><th>오후</th>
              <th>오전</th><th>오후</th>
              <th>오전</th><th>오후</th>
              <th>오전</th><th>오후</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="dropdown">
                  <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">+</button>
                  <ul class="dropdown-menu"></ul>
                </div>
              </td>
              <td colspan="17"></td>
            </tr>
          </tbody>
        </table>
        <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content text-center border border-primary">
		      <div class="modal-body">
		        <p id="alertMessage" class="fs-5 fw-bold mb-4 text-dark"></p>
		        <div class="d-flex justify-content-center">
		          <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">확인</button>
		        </div>
		      </div>
		    </div>
		  </div>
		</div>
      </div>
    </main>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="sidebar.js"></script>

<script>
function loadSidebar(activeKey) {
  $.ajax({
    url: "./sidebar.html",
    dataType: "html",
    success: function (html) {
      $("#sidebar-slot").html(html);
      const $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
      $links.removeClass("active bg-primary text-white").addClass("text-dark");
      const $current = $links.filter("[data-route='" + activeKey + "']");
      $current.addClass("active bg-primary text-white").removeClass("text-dark");
      loadSidebarInfo();
    }
  });
}
loadSidebar("manageDoctorSchedule");

function showAlert(message, onClose) {
  $("#alertMessage").text(message);
  var modal = new bootstrap.Modal(document.getElementById("alertModal"));
  $("#alertModal").on("hidden.bs.modal", function handler() {
    if (typeof onClose === "function") onClose();
    $("#alertModal").off("hidden.bs.modal", handler);
  });
  modal.show();
}

function fmtDate(d) {
  const offset = d.getTimezoneOffset();
  const local = new Date(d.getTime() - offset * 60000);
  return local.toISOString().split("T")[0];
}

function addDays(d, n) {
  const t = new Date(d.getTime());
  t.setDate(t.getDate() + n);
  return new Date(t.getFullYear(), t.getMonth(), t.getDate());
}

function startOfWeekMonday(d) {
  const t = new Date(d);
  const day = t.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  t.setDate(t.getDate() + diff);
  return new Date(t.getFullYear(), t.getMonth(), t.getDate());
}

let currentDate = new Date();

function renderDateHeader(monday) {
  const daysKor = ["일", "월", "화", "수", "목", "금", "토"];
  const headerRow = document.querySelector(".date-header");
  while (headerRow.children.length > 3) headerRow.removeChild(headerRow.lastElementChild);

  for (let i = 0; i < 7; i++) {
    const d = addDays(monday, i);
    const th = document.createElement("th");
    th.colSpan = 2;
    th.textContent = `${d.getMonth() + 1}/${d.getDate()} ${daysKor[d.getDay()]}`;
    headerRow.appendChild(th);
  }
}

function loadDoctorSchedule() {
  const monday = startOfWeekMonday(currentDate);
  const sunday = addDays(monday, 6);
  const startDate = fmtDate(monday);
  const endDate = fmtDate(sunday);

  $(".week-range").text(
    `${monday.getFullYear()}년 ${monday.getMonth() + 1}월 ${monday.getDate()}일 - ` +
    `${sunday.getMonth() + 1}월 ${sunday.getDate()}일`
  );

  renderDateHeader(monday);

  $.ajax({
    url: "controller",
    type: "GET",
    dataType: "json",
    data: { cmd: "getDoctorSchedule", startDate: startDate, endDate: endDate },
    success: function (list) {
      renderDoctorTable(list, monday);
      loadAvailableDoctors(startDate, endDate);
      $("thead input[type='checkbox']").prop("checked", false);
      $("#editBtn").show();
      $("#doctorListBtn").show();
    },
    error: function () {
      showAlert("의사 근무표 로드 중 오류가 발생했습니다.");
    }
  });
}

function renderDoctorTable(data, monday) {
  const tbody = document.querySelector("table tbody");
  const lastRow = tbody.lastElementChild.cloneNode(true);
  tbody.innerHTML = "";

  const days = Array.from({ length: 7 }, (_, i) => fmtDate(addDays(monday, i)));
  const grouped = {};

  $.each(data, function (_, item) {
    const key = item.doctorCode + "_" + item.employeeName;
    if (!grouped[key])
      grouped[key] = {
        name: item.employeeName,
        dept: item.department,
        code: item.doctorCode,
        days: {}
      };
    grouped[key].days[item.workDate] = {
      am: item.am,
      pm: item.pm,
      id: item.doctorScheduleNo
    };
  });

  $.each(Object.values(grouped), function (_, val) {
    let row = "<tr><td><input type='checkbox'></td>";
    row += `<td>${val.name}</td><td>${val.dept}</td>`;

    $.each(days, function (_, date) {
      const cell = val.days[date] || {};
      const id = cell.id || "";
      const am = cell.am === "Y" ? "<span class='circle'></span>" : "";
      const pm = cell.pm === "Y" ? "<span class='circle'></span>" : "";
      row += `<td data-id='${id}' data-code='${val.code}' data-type='am'>${am}</td>`;
      row += `<td data-id='${id}' data-code='${val.code}' data-type='pm'>${pm}</td>`;
    });

    row += "</tr>";
    $(tbody).append(row);
  });

  tbody.appendChild(lastRow);
}

function loadAvailableDoctors(startDate, endDate) {
  $.ajax({
    url: "controller",
    type: "GET",
    dataType: "json",
    data: { cmd: "getDoctorName", startDate: startDate, endDate: endDate },
    success: function (list) {
      const $dropdown = $(".dropdown-menu").empty();

      if (list.length === 0) {
        $dropdown.html(
          "<li class='dropdown-item text-center text-muted' style='pointer-events:none;'>모든 의사가 이미 등록되었습니다.</li>"
        );
        return;
      }

      $.each(list, function (_, d) {
        $dropdown.append(
          `<li class='dropdown-item'>
            <span>${d.employeeName}</span>
            <span>${d.department}</span>
            <span>${d.doctorCode}</span>
           </li>`
        );
      });

      bindDropdownEvents();
    },
    error: function () {
      showAlert("의사 명단을 불러오는 중 오류가 발생했습니다.");
    }
  });
}

function bindDropdownEvents() {
  const monday = startOfWeekMonday(currentDate);

  $(".dropdown-item").off("click").on("click", function () {
    const doctorCode = $(this).find("span").eq(2).text().trim();
    const weekDates = Array.from({ length: 7 }, (_, i) => fmtDate(addDays(monday, i)));

    const requests = weekDates.map(function (date) {
      return $.ajax({
        url: "controller",
        data: { cmd: "addDoctorSchedule", doctorCode: doctorCode, workDate: date }
      });
    });

    $.when.apply($, requests).done(loadDoctorSchedule);
  });
}

function toggleAndSave(cell) {
  const id = $(cell).data("id");
  if (!id) return;

  const hasCircle = $(cell).find(".circle").length > 0;
  $(cell).html(hasCircle ? "" : "<span class='circle'></span>");

  const $row = $(cell).closest("tr");
  const am = $row.find(`td[data-id='${id}'][data-type='am'] .circle`).length ? "Y" : "N";
  const pm = $row.find(`td[data-id='${id}'][data-type='pm'] .circle`).length ? "Y" : "N";

  $.ajax({
    url: "controller",
    data: { cmd: "editDoctorSchedule", doctorScheduleNo: id, am: am, pm: pm }
  });
}

$(document).ready(function () {
  const editBtn = $("#editBtn");
  const deleteBtn = $("#selectDeleteBtn");
  const doctorListBtn = $("#doctorListBtn");
  const checkAll = $("thead input[type='checkbox']");
  let editing = false;

  editBtn.click(function () {
	  const rowCount = $("table tbody tr").length;
	  if (rowCount <= 1) {
		    showAlert("편집할 근무가 없습니다.");
		    return;
	  }
	  
	  const lastRow = $("table tbody tr:last-child")[0];
	  const checkbox_th = $("th:has(input[type='checkbox'])");
	  const checkbox_td = $("td:has(input[type='checkbox'])");
	  editing = !editing;

	  if (editing) {
	    editBtn.text("저장하기");
	    deleteBtn.hide();
	    doctorListBtn.hide();
	    $(lastRow).hide();
	    checkbox_th.hide();
	    checkbox_td.hide();
	    $("#prev").hide();
	    $("#next").hide();

	    $("table tbody td[data-id]")
	      .css("cursor", "pointer")
	      .off("click")
	      .on("click", function (e) {
	        if ($(e.target).is(".circle")) return;
	        toggleAndSave(this);
	      });
	  } else {
	    showAlert("저장되었습니다.");
	    editBtn.text("편집하기");
	    deleteBtn.show();
	    doctorListBtn.show();
	    $(lastRow).show();
	    checkbox_th.show();
	    checkbox_td.show();
	    $("#prev").show();
	    $("#next").show();

	    $("table tbody td[data-id]").off("click").css("cursor", "default");
	    loadDoctorSchedule();
	  }
	});
  
  $(document).on("change", "input[type='checkbox']", function () {
	  const anyChecked = $("input[type='checkbox']:checked").length > 0;
	  if (anyChecked) {
	    editBtn.hide();
	    doctorListBtn.hide();
	  } else {
	    editBtn.show();
	    doctorListBtn.show();
	  }
	});


  checkAll.change(function () {
    $("tbody input[type='checkbox']").prop("checked", this.checked);
  });
  $(document).on("change", "tbody input[type='checkbox']", function () {
	  const total = $("tbody input[type='checkbox']").length;
	  const checked = $("tbody input[type='checkbox']:checked").length;
	  checkAll.prop("checked", total > 0 && total === checked);
	});


  deleteBtn.click(function () {
    const checked = $("tbody input[type='checkbox']:checked");
    if (checked.length === 0) {
      showAlert("삭제할 의사를 선택하세요.");
      return;
    }

    const count = checked.length;
    $("#confirmDeleteModal").remove();

    const modalHtml = `
      <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center border border-danger">
            <div class="modal-body">
              <p class="fs-5 fw-bold text-danger mb-4">
                선택한 ${count}명의 의사 근무 일정을 삭제하시겠습니까?
              </p>
              <div class="d-flex justify-content-center gap-3">
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">확인</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;

    $("body").append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
    modal.show();

    $(document)
      .off("click", "#confirmDeleteBtn")
      .on("click", "#confirmDeleteBtn", function () {
        const requests = [];
        checked.each(function () {
          const doctorCode = $(this).closest("tr").find("td[data-code]").data("code");
          if (!doctorCode) return true;
          requests.push(
            $.ajax({
              url: "controller",
              type: "GET",
              data: { cmd: "deleteDoctorSchedule", doctorCode: doctorCode }
            })
          );
        });

        $.when.apply($, requests).done(function () {
          modal.hide();
          showAlert("선택한 의사 근무 일정이 삭제되었습니다.", function () {
            checkAll.prop("checked", false);
            loadDoctorSchedule();
          });
        });
      });
  });

  $("#prev").click(function () {
    currentDate = addDays(currentDate, -7);
    loadDoctorSchedule();
  });

  $("#next").click(function () {
    currentDate = addDays(currentDate, 7);
    loadDoctorSchedule();
  });

  $("#doctorListBtn").click(function () {
    window.location.href = "controller?cmd=doctorListUI";
  });

  loadDoctorSchedule();
});
</script>



</body>
</html>
