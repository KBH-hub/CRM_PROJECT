<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>환자 정보 조회</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .table-fixed { table-layout: fixed; width: 100%; }
    th, td { word-wrap: break-word; }
  </style>
</head>
<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <main class="col-10 p-4">
      <div class="container-fluid bg-white border rounded shadow-sm p-4">

        <table class="table table-bordered align-middle mb-4">
          <tbody>
            <tr>
              <th class="table-secondary text-center">등록번호</th>
              <td><input id="patientNo" type="text" class="form-control" readonly></td>
              <th class="table-secondary text-center">이름</th>
              <td><input id="patientName" type="text" class="form-control"></td>
              <th class="table-secondary text-center">전화번호</th>
              <td><input id="phone" type="tel" class="form-control"></td>
            </tr>
            <tr>
              <th class="table-secondary text-center">주소</th>
              <td colspan="3"><input id="address" type="text" class="form-control"></td>
              <th class="table-secondary text-center">등록일</th>
              <td><input id="inDate" type="date" class="form-control"></td>
            </tr>
            <tr>
              <th class="table-secondary text-center">생년월일</th>
              <td><input id="birth" type="text" class="form-control"></td>
              <th class="table-secondary text-center">성별</th>
              <td>
                <select id="gender" class="form-select">
                  <option>남</option>
                  <option>여</option>
                </select>
              </td>
              <th class="table-secondary text-center">내원경로</th>
              <td><input id="path" type="text" class="form-control"></td>
            </tr>
            <tr>
              <th class="table-secondary text-center">진료과</th>
              <td><input id="department" type="text" class="form-control" readonly></td>
              <th class="table-secondary text-center">담당의사</th>
              <td><input id="employeeName" type="text" class="form-control" readonly></td>
              <th class="table-secondary text-center">입원여부</th>
              <td><input id="status" type="text" class="form-control" readonly></td>
            </tr>
          </tbody>
        </table>

        <h4 class="text-center text-white bg-secondary py-2 rounded">진료 기록</h4>
        <div class="row mt-3">
          <div class="col-3">
            <ul class="list-group" id="medicalList">
              <li class="list-group-item text-center text-muted">진료 기록 없음</li>
            </ul>
          </div>
          <div class="col-9">
            <div class="border rounded p-3 bg-light" id="medicalDetail">
              <p class="text-muted text-center">진료 항목을 선택하세요.</p>
            </div>
          </div>
        </div>

        <div class="text-end mt-4">
          <button class="btn btn-primary px-4" id="reserveBtn">예약하기</button>
          <button class="btn btn-primary px-4" id="sendSmsBtn">메시지 보내기</button>
          <button class="btn btn-primary px-4">정보 수정</button>
          <button class="btn btn-danger px-4">정보 삭제</button>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadSidebar(activeKey) {
  const slot = document.getElementById('sidebar-slot');
  const resp = await fetch('./sidebar.html');
  slot.innerHTML = await resp.text();
  const current = slot.querySelector(`[data-route="${activeKey}"]`);
  if (current) {
    slot.querySelectorAll('#sidebar-nav .nav-link').forEach(a=>{
      a.classList.remove('active','bg-primary','text-white');
      a.classList.add('text-dark');
    });
    current.classList.add('active','bg-primary','text-white');
    current.classList.remove('text-dark');
  }
}
loadSidebar('patientList');

document.getElementById("sendSmsBtn").addEventListener("click", () => {
  window.location.href = "smsService.html?tab=common";
});
document.getElementById("reserveBtn").addEventListener("click", () => {
  window.location.href = "reserveList.html?tab=reserve";
});

const params = new URLSearchParams(window.location.search);
const patientNo = params.get("patientNo");

if (patientNo) {
	  fetch(`controller?cmd=getPatientDetailAction&patientNo=${patientNo}`)
	    .then(resp => {
	      if (!resp.ok) throw new Error("서버 오류");
	      return resp.json();
	    })
	    .then(data => {
	      renderPatientInfo(data.patient);
	      renderRecordTable(data.records);
	    })
	    .catch(err => {
	      console.error(err);
	      alert("환자 정보를 불러오는 중 오류가 발생했습니다.");
	    });
	}


function renderPatientInfo(vo) {
  if (!vo) return;
  document.getElementById("patientNo").value = vo.patientNo || "";
  document.getElementById("patientName").value = vo.patientName || "";
  document.getElementById("phone").value = vo.phone || "";
  document.getElementById("address").value = vo.address || "";
  document.getElementById("inDate").value = vo.inDate || "";
  document.getElementById("birth").value = vo.birth || "";
  document.getElementById("gender").value = vo.gender === "M" ? "남" : "여";
  document.getElementById("path").value = vo.path || "";
  document.getElementById("department").value = vo.department || "";
  document.getElementById("employeeName").value = vo.employeeName || "";
  document.getElementById("status").value = vo.status || "";
}

function renderRecordTable(list) {
	  const ul = document.getElementById("medicalList");
	  ul.innerHTML = "";

	  if (!list || list.length === 0) {
	    ul.innerHTML = `<li class="list-group-item text-center text-muted py-3">진료 기록이 없습니다.</li>`;
	    return;
	  }

	  list.forEach((r, idx) => {
	    const li = document.createElement("li");
	    li.className = `list-group-item ${idx === 0 ? "active" : ""}`;
	    li.dataset.medicalDate = r.medicalDate;
	    li.dataset.diagnosis = r.diagnosis;
	    li.dataset.firstCome = r.firstCome;
	    li.dataset.employeeName = r.employeeName;
	    li.dataset.department = r.department;
	    li.dataset.insurance = r.insurance;
	    li.dataset.content = r.content;
	    li.innerHTML = `
	      ${r.medicalDate || "-"}<br>
	      <small>${r.employeeName || "-"} / ${r.department || "-"}</small>
	    `;
	    ul.appendChild(li);
	  });

	  const detail = document.getElementById("medicalDetail");

	  function renderDetail(li) {
	    if (!li) return;
	    ul.querySelectorAll(".list-group-item").forEach(el => el.classList.remove("active"));
	    li.classList.add("active");
	    detail.innerHTML = `
	      <div class="border rounded p-3 bg-light">
	        <table class="table table-bordered table-fixed mb-3">
	          <tr>
	            <th class="table-secondary text-center">진단명</th>
	            <td>${li.dataset.diagnosis || "-"}</td>
	            <th class="table-secondary text-center">진료일</th>
	            <td>${li.dataset.medicalDate || "-"}</td>
	            <th class="table-secondary text-center">초진여부</th>
	            <td>${li.dataset.firstCome || "-"}</td>
	          </tr>
	          <tr>
	            <th class="table-secondary text-center">담당의사</th>
	            <td>${li.dataset.employeeName || "-"}</td>
	            <th class="table-secondary text-center">진료과</th>
	            <td>${li.dataset.department || "-"}</td>
	            <th class="table-secondary text-center">보험 종류</th>
	            <td>${li.dataset.insurance || "-"}</td>
	          </tr>
	        </table>
	        <div>
	          <p class="mb-0"><strong class="text-primary">내용 :</strong><br>${li.dataset.content || "-"}</p>
	        </div>
	      </div>
	    `;
	  }

	  const first = ul.querySelector(".list-group-item");
	  if (first) renderDetail(first);

	  ul.addEventListener("click", e => {
	    const li = e.target.closest("li");
	    if (li) renderDetail(li);
	  });
	}

</script>
</body>
</html>
