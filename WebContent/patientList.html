<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>í™˜ì ëª©ë¡</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
#pager .page-item.active .page-link {
	background: #212529;
	color: #fff;
	border-color: #212529;
	border-radius: .6rem;
}
#pager .page-item.disabled .page-link {
	color: #bbb;
	pointer-events: none;
	background: transparent;
	border-color: transparent;
}
#pager .page-link {
	border: none;
	background: transparent;
	color: #4a4a4a;
}
</style>
</head>
<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <main class="col-10 p-4">
      <h2 class="mb-3 border-bottom pb-2">í™˜ì ê´€ë¦¬</h2>
      <div class="card"><div class="card-body">

        <!-- ğŸ” ê²€ìƒ‰ ì˜ì—­ -->
        <div class="mb-4">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="date" id="startDate" class="form-control w-auto">
            <input type="date" id="endDate" class="form-control w-auto">
            <select id="doctorSelect" class="form-select w-auto">
              <option value="">ë‹´ë‹¹ì˜ì‚¬</option>
            </select>
            <select id="searchType" class="form-select w-auto">
              <option value="birth">ìƒë…„ì›”ì¼</option>
              <option value="name">ì´ë¦„</option>
            </select>
            <input type="text" id="keyword" class="form-control w-auto" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
            <button class="btn btn-primary" id="searchBtn">ê²€ìƒ‰</button>
          </div>
        </div>

        <!-- ğŸ§¾ í™˜ì ëª©ë¡ -->
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>í™˜ìë“±ë¡ë²ˆí˜¸</th>
                <th>ì´ë¦„</th>
                <th>ì „í™”ë²ˆí˜¸</th>
                <th>ìµœê·¼ë‚´ì›ì¼</th>
                <th>ë‹´ë‹¹ì˜ì‚¬</th>
                <th>ì§„ë£Œê³¼</th>
                <th>ìƒíƒœ</th>
                <th>ì§„ë‹¨ëª…</th>
                <th>ìƒì„¸</th>
              </tr>
            </thead>
            <tbody id="patientTableBody"></tbody>
          </table>
        </div>

        <!-- âš™ ë²„íŠ¼ -->
        <div class="my-3 d-flex justify-content-center gap-2">
          <button class="btn btn-primary" id="add-btn">ê³ ê° ë“±ë¡</button>
          <button class="btn btn-primary" id="sendSmsBtn">ì„ íƒ ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
          <button class="btn btn-danger">ì„ íƒ ì‚­ì œ</button>
        </div>

        <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
        <nav aria-label="í˜ì´ì§€ ì´ë™" class="d-flex justify-content-center my-3">
          <ul id="pager" class="pagination pagination-sm align-items-center gap-2"></ul>
        </nav>
      </div></div>
    </main>
  </div>
</div>

<script>
async function loadSidebar(activeKey) {
  const slot = document.getElementById('sidebar-slot');
  const resp = await fetch('./sidebar.html');
  slot.innerHTML = await resp.text();
  const current = slot.querySelector(`[data-route="${activeKey}"]`);
  if (current) {
    slot.querySelectorAll('#sidebar-nav .nav-link').forEach(a => {
      a.classList.remove('active','bg-primary','text-white');
      a.classList.add('text-dark');
    });
    current.classList.add('active','bg-primary','text-white');
    current.classList.remove('text-dark');
  }
}
loadSidebar('patientList');

// âœ… ì „ì—­ ë³€ìˆ˜
const pageSize = 10;
let currentPage = 1;
let totalPages = 1;
let currentFilter = {
  startDate: "",
  endDate: "",
  doctorCode: "",
  searchType: "",
  keyword: ""
};

// âœ… í…Œì´ë¸” ë Œë”ë§
function renderTable(list) {
  const tbody = document.getElementById("patientTableBody");
  tbody.innerHTML = "";
  if (!list || list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-3">ì¡°íšŒëœ í™˜ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    return;
  }
  list.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" class="row-check"></td>
      <td>${p.patientNo || '-'}</td>
      <td>${p.patientName || '-'}</td>
      <td>${p.phone || '-'}</td>
      <td>${p.medicalDate || '-'}</td>
      <td>${p.employeeName || '-'}</td>
      <td>${p.department || '-'}</td>
      <td>${p.status || '-'}</td>
      <td>${p.diagnosis || '-'}</td>
      <td>
        <button class="btn btn-link p-0 detail-btn">
          <img src="detail.png" alt="ìƒì„¸ë³´ê¸°" width="24" height="24">
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// âœ… í˜ì´ì§€ë„¤ì´ì…˜
function renderPager(totalCount = 0) {
  const pager = document.getElementById('pager');
  pager.innerHTML = "";
  if (totalCount === 0 || totalPages <= 1) return;

  const addBtn = (label, action, disabled=false, active=false) => {
    const li = document.createElement("li");
    li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
    li.innerHTML = `<button class="page-link" data-action="${action}">${label}</button>`;
    pager.appendChild(li);
  };

  addBtn("Â«","first", currentPage===1);
  addBtn("â€¹","prev", currentPage===1);
  for (let i = 1; i <= totalPages; i++) {
    const li = document.createElement("li");
    li.className = `page-item ${i===currentPage?'active':''}`;
    li.innerHTML = `<button class="page-link" data-page="${i}">${i}</button>`;
    pager.appendChild(li);
  }
  addBtn("â€º","next", currentPage===totalPages);
  addBtn("Â»","last", currentPage===totalPages);

  pager.querySelectorAll(".page-link").forEach(btn => {
    btn.addEventListener("click", () => {
      const p = btn.dataset.page;
      const act = btn.dataset.action;
      if (p) loadPatientList(Number(p));
      else if (act==="first") loadPatientList(1);
      else if (act==="prev" && currentPage>1) loadPatientList(currentPage-1);
      else if (act==="next" && currentPage<totalPages) loadPatientList(currentPage+1);
      else if (act==="last") loadPatientList(totalPages);
    });
  });
}

// âœ… ë°ì´í„° ì¡°íšŒ
async function loadPatientList(page = 1) {
  try {
    const { startDate, endDate, doctorCode, searchType, keyword } = currentFilter;
    const params = new URLSearchParams({
      cmd: "getPatientListAction",
      page,
      pageSize,
      startDate,
      endDate,
      doctorCode,
      searchType,
      keyword
    });
    const resp = await fetch(`controller?${params.toString()}`);
    if (!resp.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
    const data = await resp.json();

    const list = data.list || [];
    const totalCount = data.totalCount || 0;
    if (totalCount === 0 || list.length === 0) {
      totalPages = 0;
      currentPage = 1;
      renderTable([]);
      renderPager(0);
      return;
    }

    totalPages = Math.ceil(totalCount / pageSize);
    currentPage = page;
    renderTable(list);
    renderPager(totalCount);
  } catch (err) {
    console.error(err);
    alert("í™˜ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

// âœ… ë©”ì¸ ë¡œì§
document.addEventListener("DOMContentLoaded", () => {
  const startInput = document.getElementById("startDate");
  const endInput = document.getElementById("endDate");
  const doctorSelect = document.getElementById("doctorSelect");
  const searchType = document.getElementById("searchType");
  const keywordInput = document.getElementById("keyword");
  const searchBtn = document.getElementById("searchBtn");

  // ì „ì²´ ì„ íƒ
  document.getElementById("selectAll").addEventListener("change", e => {
    document.querySelectorAll(".row-check").forEach(chk => chk.checked = e.target.checked);
  });

  // ë²„íŠ¼ ì´ë™
  document.getElementById("sendSmsBtn").addEventListener("click", () => window.location.href = "smsService.html?tab=common");
  document.getElementById("add-btn").addEventListener("click", () => window.location.href = "patientAdd.html");

  // ìƒì„¸ë³´ê¸°
  document.addEventListener("click", e => {
    const btn = e.target.closest(".detail-btn");
    if (btn) window.location.href = "patientInfo.html";
  });

  // ë‚ ì§œ ê²€ì¦ + ì¡°íšŒ
  // âœ… ë‚ ì§œê°€ ì—†ì–´ë„ ê²€ìƒ‰ ë™ì‘
	async function validateDates() {
	  let start = startInput.value;
	  let end = endInput.value;
	  
	  // ì‹œì‘ì¼ > ì¢…ë£Œì¼ì¼ ë•Œë§Œ ì •ì •
	  if (start && end && start > end) {
	    end = start;
	    endInput.value = start;
	  }
	
	  // ë‚ ì§œ ë‘˜ ë‹¤ ìˆì„ ë•Œë§Œ ì˜ì‚¬ ëª©ë¡ ë¡œë“œ
	  if (start && end) {
	    await loadDoctorList(start, end);
	  }
	
	  currentFilter = {
	    startDate: start || "",
	    endDate: end || "",
	    doctorCode: doctorSelect.value || "",
	    searchType: searchType.value || "",
	    keyword: keywordInput.value.trim() || ""
	  };
	
	  // ë‚ ì§œ ì—†ì–´ë„ í™˜ì ëª©ë¡ ì¡°íšŒ
	  await loadPatientList(1);
	  return true;
	}


  async function loadDoctorList(startDate, endDate) {
    try {
      const prevValue = doctorSelect.value; // âœ… ê¸°ì¡´ ì„ íƒ ê¸°ì–µ
    	
      const resp = await fetch(`controller?cmd=getDoctorListByDateAction&startDate=${startDate}&endDate=${endDate}`);
      if (!resp.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
      const list = await resp.json();
      doctorSelect.innerHTML = `<option value="">ì „ì²´</option>`;
      list.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.doctorCode ?? "";;
        opt.textContent = `${d.employeeName} (${d.department}, ${d.doctorCode})`;
        doctorSelect.appendChild(opt);
      });
      
  	   // âœ… ê¸°ì¡´ ì„ íƒ ë³µì› (ì˜ì‚¬ ì½”ë“œê°€ ì—¬ì „íˆ ëª©ë¡ì— ìˆìœ¼ë©´ ìœ ì§€)
      if ([...doctorSelect.options].some(o => o.value === prevValue)) {
        doctorSelect.value = prevValue;
      }
      
      doctorSelect.disabled = false;
   
    } catch (err) {
      console.error(err);
      alert("ì˜ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      doctorSelect.disabled = true;
    }
  }

  // ê²€ìƒ‰ í•¨ìˆ˜
  async function searchPatients() {
    if (!await validateDates()) return;
    currentFilter = {
      startDate: startInput.value,
      endDate: endInput.value,
      doctorCode: doctorSelect.value,
      searchType: searchType.value,
      keyword: keywordInput.value.trim()
    };
    await loadPatientList(1);
  }

  // ì´ë²¤íŠ¸ ë“±ë¡
  startInput.addEventListener("change", validateDates);
  endInput.addEventListener("change", validateDates);
  doctorSelect.addEventListener("change", validateDates);
  searchBtn.addEventListener("click", searchPatients);
  keywordInput.addEventListener("keypress", e => {
    if (e.key === "Enter") searchPatients();
  });

  // ì²« í˜ì´ì§€ ë¡œë“œ
  loadPatientList(1);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
