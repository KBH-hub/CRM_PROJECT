<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>환자 관리</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <main class="col-10 p-4">
      <h2 class="mb-3 border-bottom pb-2">환자 관리</h2>
      <div class="card">
      <div class="card-body">
		<div class="mb-4 d-flex flex-wrap justify-content-between align-items-center">
		  <div class="d-flex flex-wrap gap-2 align-items-center">
		    <input type="date" id="startDate" class="form-control w-auto">
		    <input type="date" id="endDate" class="form-control w-auto">
		    <select id="doctorSelect" class="form-select" style="width:250px;">
		    </select>
		    <select id="searchType" class="form-select w-auto">
		      <option value="name">이름</option>
		      <option value="birth">생년월일</option>
		    </select>
		    <input type="text" id="keyword" class="form-control w-auto" placeholder="검색어 입력">
		    <button class="btn btn-primary" id="searchBtn">검색</button>
		  </div>
		
		  <div class="d-flex gap-2">
		    <button class="btn btn-primary" id="add-btn">환자 등록</button>
		    <button class="btn btn-primary" id="sendSMSBtn">선택 메시지 보내기</button>
		    <button class="btn btn-danger" id="deleteSelectedBtn">선택 삭제</button>
		  </div>
		</div>

        <div class="table-responsive">
		  <table class="table table-bordered align-middle text-center" style="table-layout: fixed; width: 100%;">
		    <thead class="table-light">
		      <tr>
		        <th style="width:4%;"><input type="checkbox" id="selectAll"></th>
		        <th style="width:8%;">환자등록번호</th>
		        <th style="width:10%;">이름</th>
		        <th style="width:12%;">전화번호</th>
		        <th style="width:10%;">최근내원일</th>
		        <th style="width:10%;">담당의사</th>
		        <th style="width:10%;">진료과</th>
		        <th style="width:10%;">입원 여부</th>
		        <th style="width:25%;">진단명</th>
		        <th style="width:5%;">상세</th>
		      </tr>
		    </thead>
		    <tbody id="patientTableBody"></tbody>
		  </table>
		</div>
       	<nav aria-label="페이지 이동" class="d-flex justify-content-center my-3">
       		<ul id="pager" class="pagination pagination-sm align-items-center gap-2"></ul>
       	</nav>
      </div>

      <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content text-center border border-primary">
		      <div class="modal-body">
		        <p id="alertMessage" class="fs-5 fw-bold mb-4 text-dark"></p>
		        <div class="d-flex justify-content-center">
		          <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">확인</button>
		        </div>
		      </div>
		    </div>
		  </div>
		</div>
      </div>
    </main>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="sidebar.js"></script>

<script>
function loadSidebar(activeKey) {
	  $.ajax({
	    url: "./sidebar.html",
	    dataType: "html",
	    success: function (html) {
	      $("#sidebar-slot").html(html);
	      var $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
	      $links.removeClass("active bg-primary text-white").addClass("text-dark");
	      var $current = $links.filter("[data-route='" + activeKey + "']");
	      $current.addClass("active bg-primary text-white").removeClass("text-dark");
	      loadSidebarInfo();
	    }
	  });
	}
loadSidebar("patientList");

function showAlert(message, onClose) {
  $("#alertMessage").text(message);
  var modal = new bootstrap.Modal(document.getElementById("alertModal"));
  $("#alertModal").on("hidden.bs.modal", function handler() {
    if (typeof onClose === "function") onClose();
    $("#alertModal").off("hidden.bs.modal", handler);
  });
  modal.show();
}

var pageSize = 10;
var currentPage = 1;
var totalPages = 1;
var currentFilter = {
  startDate: "",
  endDate: "",
  doctorCode: "",
  searchType: "",
  keyword: ""
};

function renderTable(list) {
  var $tbody = $("#patientTableBody");
  $tbody.empty();
  if (!list || list.length === 0) {
    $tbody.html("<tr><td colspan='10' class='text-center text-muted py-3'>조회된 환자 정보가 없습니다.</td></tr>");
    return;
  }
  $.each(list, function(i, p) {
    var tr = `
      <tr>
        <td><input type="checkbox" class="row-check"></td>
        <td>${p.patientNo || '-'}</td>
        <td>${p.patientName || '-'}</td>
        <td>${p.phone || '-'}</td>
        <td>${p.medicalDate || '-'}</td>
        <td>${p.employeeName || '-'}</td>
        <td>${p.department || '-'}</td>
        <td>${p.status || '-'}</td>
        <td>${p.diagnosis || '-'}</td>
        <td><button class="btn btn-link p-0 detail-btn">
          <img src="img/detail.png" alt="상세보기" width="24" height="24">
        </button></td>
      </tr>`;
    $tbody.append(tr);
  });
}

function renderPager(totalCount) {
  var $pager = $("#pager");
  $pager.empty();
  if (totalCount === 0 || totalPages <= 1) return;
  function addBtn(label, action, disabled, active) {
    var li = `<li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                <button class="page-link" data-action="${action}">${label}</button></li>`;
    $pager.append(li);
  }
  addBtn("«", "first", currentPage === 1);
  addBtn("‹", "prev", currentPage === 1);
  for (var i = 1; i <= totalPages; i++) addBtn(i, "", false, i === currentPage);
  addBtn("›", "next", currentPage === totalPages);
  addBtn("»", "last", currentPage === totalPages);
  $pager.find(".page-link").click(function() {
    var act = $(this).data("action");
    var text = $(this).text();
    if ($.isNumeric(text)) loadPatientList(Number(text));
    else if (act === "first") loadPatientList(1);
    else if (act === "prev" && currentPage > 1) loadPatientList(currentPage - 1);
    else if (act === "next" && currentPage < totalPages) loadPatientList(currentPage + 1);
    else if (act === "last") loadPatientList(totalPages);
  });
}

function loadPatientList(page) {
  var params = $.extend({}, currentFilter, {
    cmd: "getPatientListAction",
    page: page,
    pageSize: pageSize
  });
  $.ajax({
    url: "controller",
    type: "GET",
    data: params,
    dataType: "json",
    success: function(data) {
      var list = data.list || [];
      var totalCount = data.totalCount || 0;
      if (totalCount === 0) {
        totalPages = 0;
        currentPage = 1;
        renderTable([]);
        renderPager(0);
        return;
      }
      totalPages = Math.ceil(totalCount / pageSize);
      currentPage = page;
      renderTable(list);
      renderPager(totalCount);
      $("#selectAll").prop("checked", false);
    },
    error: function() {
      showAlert("환자 목록을 불러오는 중 오류가 발생했습니다.");
    }
  });
}

function loadDoctorList(startDate, endDate) {
  var prevValue = $("#doctorSelect").val();
  $.ajax({
    url: "controller",
    type: "GET",
    data: { cmd: "getDoctorListByDateAction", startDate: startDate, endDate: endDate },
    dataType: "json",
    success: function(list) {
      var $doctorSelect = $("#doctorSelect");
      $doctorSelect.empty().append('<option value="">담당 의사 선택</option>');
      $.each(list, function(i, d) {
        var code = d.doctorCode ? d.doctorCode : "";
        var opt = '<option value="' + code + '">' +
                   d.employeeName + ' (' + d.department + ', ' + code + ')' +
                   '</option>';
        $doctorSelect.append(opt);
      });
      if ($doctorSelect.find("option[value='" + prevValue + "']").length > 0)
        $doctorSelect.val(prevValue);
      else $doctorSelect.val("");
      $doctorSelect.prop("disabled", false);
    },
    error: function() {
      showAlert("의사 목록을 불러오는 중 오류가 발생했습니다.");
    }
  });
}

function validateDates() {
  var start = $("#startDate").val();
  var end   = $("#endDate").val();
  if (start && end && start > end) {
    end = start;
    $("#endDate").val(start);
  }
  if (start || end) loadDoctorList(start, end);
  currentFilter = {
    startDate: start || "",
    endDate: end || "",
    doctorCode: $("#doctorSelect").val() || "",
    searchType: $("#searchType").val() || "",
    keyword: $("#keyword").val().trim() || ""
  };
  loadPatientList(1);
  return true;
}

$(document).ready(function() {
	
  $("#selectAll").change(function() {
    $(".row-check").prop("checked", this.checked);
  });
 
  $(document).on("change", ".row-check", function() {
	  const total = $(".row-check").length;
	  const checked = $(".row-check:checked").length;
	  $("#selectAll").prop("checked", total > 0 && total === checked);

	  const anyChecked = checked > 0;
	});

  $("#add-btn").click(function() {
    window.location.href = "controller?cmd=addPatientUI";
  });
  
  $("#sendSMSBtn").click(function() {
  var checked = $(".row-check:checked");
    if (checked.length === 0) {
      showAlert("메시지 발송할 환자를 선택하세요.");
      return;
    }
    var ids = [];
    checked.each(function() {
      ids.push($(this).closest("tr").children().eq(1).text().trim());
    });
    const query = ids.map(id => "patientNo=" + encodeURIComponent(id)).join("&");
    window.location.href = "SMSService.html?tab=common&"+query;
  });

  $(document).on("click", ".detail-btn", function() {
    var patientNo = $(this).closest("tr").children().eq(1).text().trim();
    window.location.href = "controller?cmd=patientInfoUI&patientNo=" + encodeURIComponent(patientNo);
  });

  $("#searchBtn").click(function() {
    currentFilter = {
      startDate: $("#startDate").val(),
      endDate: $("#endDate").val(),
      doctorCode: $("#doctorSelect").val(),
      searchType: $("#searchType").val(),
      keyword: $("#keyword").val().trim()
    };
    $("#selectAll").prop("checked", false);
    loadPatientList(1);
  });
  
  $("#keyword").keypress(function(e) {
	    if (e.key === "Enter") $("#searchBtn").click();
  });

  $("#startDate, #endDate, #doctorSelect").change(validateDates);

  $("#deleteSelectedBtn").click(function() {
    var checked = $(".row-check:checked");
    if (checked.length === 0) {
      showAlert("삭제할 환자를 선택하세요.");
      return;
    }
    var ids = [];
    checked.each(function() {
      ids.push($(this).closest("tr").children().eq(1).text().trim());
    });
    var confirmModalHtml = `
      <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center border border-danger">
            <div class="modal-body">
              <p class="fs-5 fw-bold text-danger mb-4">선택한 ${ids.length}명의 환자를 삭제하시겠습니까?</p>
              <div class="d-flex justify-content-center gap-3">
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">확인</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    $("#confirmDeleteModal").remove();
    $("body").append(confirmModalHtml);
    var modal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
    modal.show();
    $(document).off("click", "#confirmDeleteBtn").on("click", "#confirmDeleteBtn", function() {
      $.ajax({
        url: "controller?cmd=deletePatientAction",
        type: "POST",
        data: { patientNoList: ids.join(",") },
        success: function() {
          modal.hide();
          showAlert("선택한 환자 정보가 삭제되었습니다.", function() {
            loadPatientList(currentPage);
          });
        },
        error: function() {
          modal.hide();
          showAlert("삭제 중 오류가 발생했습니다.");
        }
      });
    });
  });

  loadDoctorList($("#startDate").val() || "", $("#endDate").val() || "");
  loadPatientList(1);
});
</script>
</body>
</html>
