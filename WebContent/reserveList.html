<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>예약 관리</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
table, th, td {
	border-collapse: collapse;
}

#container {
	margin-top: 20px;
}

.calendar-controls {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 10px;
	margin-bottom: 15px;
}

/* ✅ 날짜를 오른쪽 상단으로 정렬 */
.month-view td {
	position: relative;
	height: 80px;
	vertical-align: top !important;
}

.month-view td strong {
	position: absolute;
	top: 4px;
	right: 6px;
	font-size: 0.9rem;
}

.month-view td small {
	display: block;
	margin-top: 22px;
	font-size: 0.75rem;
	color: #555;
}

/* ✅ 주간 / 일간 달력의 표 높이 축소 */
.week-view td, .day-view td {
	height: 36px;
	padding: 4px 6px !important;
	font-size: 0.85rem;
	vertical-align: middle !important;
}

/* 선택 강조 */
.table-hover tbody tr.table-active td {
	background-color: #e7f1ff !important;
}

/* Day 뷰 컨테이너 */
.day-view-grid {
	border: 1px solid #dee2e6; /* 테이블 테두리처럼 보이게 */
	border-radius: 0.375rem; /* Bootstrap 기본 라운드 코너 */
	overflow: hidden; /* 내부 요소가 넘치지 않도록 */
	background-color: #fff; /* 배경색 */
}

/* 시간 축 */
.time-axis {
	flex-shrink: 0; /* 크기가 줄어들지 않도록 */
	background-color: #f8f9fa; /* 배경색 */
	padding-top: 2px; /* 위쪽 여백 */
}

.time-label {
	height: 60px; /* 각 시간 블록의 높이 (스크린샷 기준) */
	line-height: 60px; /* 텍스트 수직 중앙 정렬 */
	font-weight: bold;
	font-size: 0.9rem;
	color: #495057;
	border-bottom: 1px solid #dee2e6; /* 시간 레이블 아래 구분선 */
}

.time-label:last-child {
	border-bottom: none; /* 마지막 시간 레이블은 아래 구분선 제거 */
}

/* 예약 내용 영역 */
.reservation-content {
	background-color: #fff; /* 배경색 */
	padding-left: 5px; /* 왼쪽 여백 */
	padding-right: 5px; /* 오른쪽 여백 */
}

.hour-slot {
	height: 60px; /* time-label과 동일하게 설정 */
	display: flex; /* 예약 블록들을 가로로 배치 */
	flex-wrap: wrap; /* 공간이 부족하면 다음 줄로 */
	align-content: flex-start; /* 예약 블록들이 위에서부터 채워지도록 */
	border-bottom: 1px solid #dee2e6; /* 각 시간 슬롯 아래 구분선 */
}

.hour-slot:last-child {
	border-bottom: none !important; /* 마지막 시간 슬롯은 아래 구분선 제거 */
}

.reservation-block {
	cursor: pointer; /* 클릭 가능한 요소처럼 보이게 */
	font-size: 0.75rem; /* 예약 블록 텍스트 크기 */
	white-space: nowrap; /* 텍스트 줄바꿈 방지 */
	overflow: hidden; /* 넘치는 텍스트 숨김 */
	text-overflow: ellipsis; /* 넘치는 텍스트 ... 처리 */
	max-width: 100%; /* 부모 너비를 넘지 않도록 */
	height: fit-content; /* 내용에 맞춰 높이 조절 */
	/* 스크린샷의 색상들을 반영하여 여러 스타일 클래스 추가 가능 */
	/* 예: text-bg-primary, text-bg-success, text-bg-warning 등 */
	/* 지금은 text-bg-primary로 통일합니다. */
}
/* 스크린샷처럼 여러 색상을 사용하고 싶다면, 백엔드에서 예약마다 색상 관련 필드를 추가하거나,
    진료과 등에 따라 동적으로 클래스를 부여하는 로직이 필요합니다. */
.reservation-block.bg-success {
	background-color: #198754 !important;
}

.reservation-block.bg-info {
	background-color: #0dcaf0 !important;
}

.reservation-block.bg-warning {
	background-color: #ffc107 !important;
}
/* 등등... */
</style>
</head>

<body class="bg-body-tertiary">
	<div class="container-fluid">
		<div class="row">

			<div id="sidebar-slot" class="col-2 p-0"></div>

			<main class="col-10 p-4">
			<div class="container py-4">
				<h2 class="text-center mb-4">예약 관리</h2>

				<div class="calendar-controls">
					<div class="d-inline-flex align-items-center">
						<label for="viewSelect" class="me-2 mb-0 fw-bold">월/주/일 선택</label>
						<select id="viewSelect" class="form-select form-select-sm w-auto">
							<option value="month" selected>월</option>
							<option value="week">주</option>
							<option value="day">일</option>
						</select>
					</div>

					<div>
						<button id="prev" class="btn btn-outline-dark">◀</button>
						<span id="ym" class="fw-bold fs-5">—</span>
						<button id="next" class="btn btn-outline-dark">▶</button>
					</div>
				</div>

				<div id="container"></div>

			</div>

			<div class="d-flex justify-content-end gap-2 mt-4 pe-4">
				<button class="btn btn-primary px-4" data-bs-toggle="modal"
					data-bs-target="#reservationModal" id="reserveBtn">예약 등록</button>
				<button id="openListBtn" class="btn btn-primary px-4" data-bs-toggle="modal"
					data-bs-target="#managerReservationModal">예약 목록</button>
			</div>
			</main>
		</div>
	</div>


	<div class="modal fade" id="reservationModal" tabindex="-1"
		aria-hidden="true">
		<div
			class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content custom-modal-size">
				<div class="modal-header">
					<h5 class="modal-title fw-bold text-center">예약 등록</h5>
					<button class="btn btn-primary modal-back-btn">닫기</button>
				</div>

				<div class="modal-body">
					<form>
						<div class="col-md-4 mb-3">
							<label class="form-label">이름</label>
							<div class="input-group">
								<input type="text" id="patientName" class="form-control"
									readonly>
								<button class="btn btn-outline-danger" type="button"
									data-bs-toggle="modal" data-bs-target="#patientSearchModal">환자
									조회</button>
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">일시</label>
							<div class="row g-2 align-items-center">
								<div class="col-md-4 col-12">
									<input type="date" class="form-control" id="reserveDate"
										required>
								</div>
								<div class="col-md-2 col-3">
									<select class="form-select" id="reserveHour" required>

										<option value="" selected disabled>시</option>
									</select>
								</div>
								<div class="col-md-2 col-3">
									<select class="form-select" id="reserveMinute" required>

										<option value="" selected disabled>분</option>
										<option value="00">00</option>
										<option value="30">30</option>
									</select>
								</div>
							</div>
						</div>

						<div class="col-md-4 mb-3">
							<label class="form-label">환자연락처</label> <input type="text"
								id="patientPhone" class="form-control" readonly>
						</div>

						<div class="col-md-4 mb-3">
							<label class="form-label">담당의사 / 진료과</label> <select
								class="form-select" id="doctorSelect">
								<option value="" selected>-</option>
								<option>신경외과 / 나신경 / DN002</option>
								<option>정형외과 / 원장 / DO003</option>
								<option>정형외과 / 김의사 / DO001</option>
							</select>
						</div>

						<div class="col-md-7">
							<label class="form-label">내원 사유</label>
							<textarea class="form-control" id="visitReason"></textarea>
						</div>
					</form>
				</div>

				<div class="modal-footer justify-content-center">
					<button class="btn btn-primary">저장</button>
					<button class="btn btn-primary modal-back-btn">취소</button>
					<button class="btn btn-primary">문자보내기</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="patientSearchModal" tabindex="-1"
		aria-hidden="true">
		<div
			class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">환자 검색</h5>
					<button class="btn btn-primary modal-back-btn">닫기</button>
				</div>
				<div class="modal-body">

					<div class="input-group mb-3">
						<input type="text" id="patientSearchInput" class="form-control"
							placeholder="환자 이름">
						<button class="btn btn-primary" type="button" id="searchBtn">검색</button>
						<button class="btn btn-outline-secondary" type="button"
							id="clearSearchBtn">초기화</button>
					</div>

					<table class="table table-hover mb-0">
						<thead>
							<tr>
								<th>환자번호</th>
								<th>이름</th>
								<th>연락처</th>
								<th>최근내원일</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>6102</td>
								<td>이승희</td>
								<td>010-1111-2222</td>
								<td>2025-09-03</td>
							</tr>
							<tr>
								<td>5800</td>
								<td>이승희</td>
								<td>010-2656-5566</td>
								<td>2023-07-05</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="modal-footer">
					<button class="btn btn-primary" id="selectPatientBtn">선택</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="managerReservationModal" tabindex="-1"
		aria-hidden="true">
		<div
			class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content custom-modal-size">

				<div class="modal-header">
					<div class="d-flex gap-2">
						<h5 class="modal-title fw-bold">전체 예약 목록</h5>
					</div>
					<div>
						<button class="btn btn-primary" data-bs-dismiss="modal">닫기</button>
					</div>
				</div>

				<div class="modal-body">
					<div class="row mb-3">
						<div class="row g-3 mb-3 align-items-end">
							<div class="col-md-3">
								<label class="form-label">월</label> <input type="month"
									id="filterMonth" class="form-control">
							</div>
							<div class="col-md-3">
								<label class="form-label">주(월~일)</label> <select id="filterWeek"
									class="form-select">
									<option value="">주 선택</option>
									<!-- JS가 9월 15일 - 9월 21일 형식 옵션 자동 생성 -->
								</select> <input type="hidden" id="filterWeekStart"> <input
									type="hidden" id="filterWeekEnd">
							</div>
							<!-- 일 -->
							<div class="col-md-3">
								<label class="form-label">일</label> <select id="filterDay"
									class="form-select" disabled>
									<option value="">주를 먼저 선택하세요</option>
								</select>
							</div>
							<div class="col-md-3">
								<label class="form-label">시간</label> <select id="filterHour"
									class="form-select" disabled>
									<option value="">전체</option>
									<option value="07">07시</option>
									<option value="08">08시</option>
									<option value="09">09시</option>
									<option value="10">10시</option>
									<option value="11">11시</option>
									<option value="12">12시</option>
									<option value="13">13시</option>
									<option value="14">14시</option>
									<option value="15">15시</option>
									<option value="16">16시</option>
									<option value="17">17시</option>
									<option value="18">18시</option>
									<option value="19">19시</option>
								</select>
							</div>
						</div>

						<div class="table-responsive">
							<table id="reserveTable"
								class="table table-bordered text-center align-middle">
								<thead class="table-light">
									<tr>
										<th scope="col"><input type="checkbox" class="selectAll"></th>
										<th scope="col">이름</th>
										<th scope="col">방문 예정 일</th>
										<th scope="col">방문 예정 시간</th>
										<th scope="col">담당의사</th>
										<th scope="col">진료과</th>
										<th scope="col">상세</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="6" class="text-muted">검색 결과가 없습니다.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>


				</div>
				<div class="modal-footer d-flex justify-content-between">
					<div class="d-flex gap-2">
						<button id="sendReserveSMSSelectBtn" class="btn btn-primary"
							data-bs-dismiss="modal">선택 메시지 보내기</button>
						<button id="sendReserveSMSSelectBtn" class="btn btn-primary"
							data-bs-dismiss="modal">선택 예약 삭제</button>
					</div>
				</div>
			</div>
		</div>
		</div>

		<div class="modal fade" id="reservationDetailModal" tabindex="-1"
			aria-hidden="true">
			<div
				class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
				<div class="modal-content custom-modal-size">
					<div class="modal-header">
						<h5 class="modal-title fw-bold">예약 상세</h5>
						<button class="btn btn-primary modal-back-btn">닫기</button>
					</div>

					<div class="modal-body">
						<form id="reservationForm">
							<div class="mb-3 col-md-4">
								<label class="form-label">이름</label> <input type="text"
									id="detailName" class="form-control" readonly>
							</div>

							<div class="mb-3">
								<label class="form-label">일시</label>
								<div class="row g-2 align-items-center">
									<div class="col-md-4 col-12">
										<input type="date" id="visitDate" class="form-control"
											readonly>
									</div>
									<div class="col-md-2 col-3">
									 <select class="form-select" id="visitHour" required disabled>
										<option value="" selected disabled>시</option>
									 </select>                
									</div>
									               
									<div class="col-md-2 col-3">
										<select class="form-select" id="visitMinute" required disabled>
											<option value="" selected disabled>분</option>
											<option value="00">00</option>
											<option value="30">30</option>
											</select>                
									</div>
								</div>
							</div>

							<div class="mb-3 col-md-4">
								<label class="form-label">환자연락처</label> <input type="text"
									id="detailPhone" class="form-control" value="" readonly>
							</div>

							<div class="mb-3 col-md-4">
								<label class="form-label">담당의사 / 진료과</label> <select
									id="doctorDept" class="form-select" disabled>
									<option>신경외과 / 나신경 / DN002</option>
									<option>정형외과 / 원장 / DO003</option>
									<option>정형외과 / 김의사 / DO001</option>
								</select>
							</div>

							<div class="mb-3">
								<label class="form-label">내원 사유</label> <input type="text"
									id="visitReasonInput" class="form-control" value="수술 이후 손발 저림"
									readonly>
								<textarea id="visitReasonTextarea" class="form-control d-none">수술 이후 손발 저림</textarea>
							</div>
						</form>
					</div>

					<div class="modal-footer justify-content-center">
						<button id="editBtn" class="btn btn-primary">수정</button>
						<button id="saveBtn" class="btn btn-success d-none">저장</button>
						<button id="deleteBtn" class="btn btn-danger"
							data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">삭제</button>
						<button id="messageBtn" class="btn btn-secondary">메시지보내기</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="deleteConfirmModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content text-center border border-danger">
					<div class="modal-body">
						<p class="fs-5 fw-bold text-danger mb-4">삭제하시겠습니까!?</p>
						<div class="d-flex justify-content-center gap-3">
							<button type="button" class="btn btn-primary"
								id="confirmDeleteBtn">확인</button>
							<button type="button" class="btn btn-primary"
								data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script
			src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="sidebar.js"></script>
		<script>
// ---------- 사이드바 로드 ----------
function loadSidebar(activeKey) {
  $.ajax({
    url: "./sidebar.html",
    dataType: "html",
    success: function (html) {
      $("#sidebar-slot").html(html);
      var $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
      $links.removeClass("active bg-primary text-white").addClass("text-dark");
      var $current = $links.filter("[data-route='" + activeKey + "']");
      $current.addClass("active bg-primary text-white").removeClass("text-dark");
      loadSidebarInfo();
    }
  });
}
loadSidebar("reserve");

//---------- 공용 유틸 ----------
const container = document.getElementById('container');
const ymSpan = document.getElementById('ym');
let fetchedDailyReservationCounts = [];

// ⭐ 수정된 부분: viewDate 초기화에서 setDate(1) 제거 ⭐
let viewMode = 'month';
let viewDate = new Date(); // 오늘 날짜로 초기화


const fmt = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
// ⭐ 추가된 부분: 월만 표시하는 포맷 함수 ⭐
const fmtMonth = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

const addDays = (d, n) => { const t = new Date(d); t.setDate(t.getDate() + n); return t; };
const startOfWeekMonday = d => { const t = new Date(d); const day = t.getDay(); const diff = (day === 0 ? -6 : 1 - day); t.setDate(t.getDate() + diff); return t; };


function fillVisitHourOptions(selectedHour = '') { // 기본값으로 빈 문자열을 설정
    const visitHourSelect = document.getElementById("visitHour");
    if (!visitHourSelect) return;

    let hourOptions = '<option value="" disabled>시</option>'; // 초기 '시' 옵션은 선택되지 않도록 변경
    for (let i = 8; i <= 19; i++) {
        const hour = String(i).padStart(2, '0');
        // 현재 시간(hour)이 selectedHour와 일치하면 selected 속성 추가
        const isSelected = (hour === selectedHour) ? 'selected' : '';
        hourOptions += `<option value="${hour}" ${isSelected}>${hour}</option>`;
    }
    visitHourSelect.innerHTML = hourOptions;
   
}

function fillVisitMinuteOptions(selectedMinute = '') {
    const visitMinuteSelect = document.getElementById("visitMinute");
    if (!visitMinuteSelect) return;

    let minuteOptionsHtml = '<option value="" disabled>분</option>'; // 초기 '분' 옵션
    const minutes = ['00', '30']; // 00분과 30분만 허용한다고 가정
    minutes.forEach(m => {
        const isSelected = (m === selectedMinute) ? 'selected' : '';
        minuteOptionsHtml += `<option value="${m}" ${isSelected}>${m}</option>`;
    });
    visitMinuteSelect.innerHTML = minuteOptionsHtml;
}
   

async function fetchAndRenderCalendarData() {
    const year = viewDate.getFullYear();
    const month = (viewDate.getMonth() + 1).toString().padStart(2, '0');
    const monthStr = `${year}-${month}`;

    let apiUrl = '';
    let params = '';

    if (viewMode === 'month'){
        apiUrl = 'controller?cmd=countReserveMonth';
        params = `&month=${monthStr}`;
    } else if (viewMode === 'week') {
        apiUrl = 'controller?cmd=countReserveWeekByTime';
        const monday = startOfWeekMonday(viewDate);
        const sunday = addDays(monday, 6);
        params = `&startDate=${fmt(monday)}&endDate=${fmt(sunday)}`;
    } else if (viewMode === 'day') {
        apiUrl = 'controller?cmd=getReserveDay';
        params = `&targetDate=${fmt(viewDate)}`;
    }

    try {
        const response = await fetch(`${apiUrl}${params}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        fetchedDailyReservationCounts = data;
        render(); // 데이터가 성공적으로 로드되면 렌더링
    } catch (error) {
        console.error('캘린더 데이터를 가져오는 중 오류 발생:', error);
        alert('예약 데이터를 불러오지 못했습니다. 다시 시도해 주세요.');
        container.innerHTML = '<p class="text-danger">예약 데이터를 불러오는 데 실패했습니다.</p>';
    }
}


//---------- 캘린더 렌더 ----------
function render(){
    if(viewMode==='month') renderMonth();
    else if(viewMode==='week') renderWeek();
    else if(viewMode==='day') renderDay();

}

function renderMonth(){
    const y = viewDate.getFullYear(); 
    const m = viewDate.getMonth(); 

   
    const currentMonthDate = new Date(y, m, 1);
    ymSpan.textContent = fmtMonth(currentMonthDate); 

    const dailyCountsMap = new Map();
    if (Array.isArray(fetchedDailyReservationCounts)) {
        fetchedDailyReservationCounts.forEach(item => {
     
            dailyCountsMap.set(parseInt(item.reserveDay.split('-')[2]), item.reserveCount);
        });
    }

    
    let firstDayOfWeek = new Date(y, m, 1).getDay();
    
    if(firstDayOfWeek === 0) firstDayOfWeek = 7;

    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const wd = ['일','월','화','수','목','금','토'];
    let html = '<table class="table table-bordered text-center align-middle month-view"><thead><tr>';
    wd.forEach(d => html += `<th>${d}</th>`);
    html += '</tr></thead><tbody>';

    let day = 1; 
    let started = false; 

    for(let r = 0; r < 6 && day <= daysInMonth; r++){
        html += '<tr>';
        for(let c = 0; c < 7; c++){
            if (!started && c < firstDayOfWeek) { 
                html += '<td></td>';
            } else if (day > daysInMonth) { // 해당 월의 마지막 날짜 이후 셀은 비워둠
                html += '<td></td>';
            } else {
                const totalCount = dailyCountsMap.get(day) || 0; // 해당 일자의 예약 건수, 없으면 0
                const isToday = (new Date().getFullYear() === y && new Date().getMonth() === m && new Date().getDate() === day);
                const tdClass = (c === 0 || c === 6) ? 'weekend' : ''; // 일요일(0) 또는 토요일(6)은 주말

                html += `<td class="${tdClass} ${isToday ? 'today' : ''}"><strong>${day}</strong><small>총 예약 ${totalCount}건</small></td>`;
                day++;
                started = true;
            }
        }
        html += '</tr>';
    }
    html += '</tbody></table>';
    container.innerHTML = html;

    // ⭐ 툴팁 초기화: DOM이 업데이트된 후 호출 ⭐
    initTooltips();
}


function renderWeek(){
    const mon = startOfWeekMonday(viewDate);
    const weekDays = [...Array(7)].map((_, i) => addDays(mon, i));
    ymSpan.textContent = `${fmt(weekDays[0])} ~ ${fmt(weekDays[6])}`;

    const hourlyCountsMap = new Map();
    if (Array.isArray(fetchedDailyReservationCounts)) {
        fetchedDailyReservationCounts.forEach(item => {
            const dayKey = item.reserveDay;
            const hour = item.reserveTime ? item.reserveTime.substring(0, 2) : '00';
            const count = item.reserveCount;
            const mapKey = `${dayKey}_${hour}`;
            hourlyCountsMap.set(mapKey, (hourlyCountsMap.get(mapKey) || 0) + count);
        });
    }

    const hours = [...Array(13)].map((_, i) => i + 7);

    let html = '<table class="table table-bordered text-center align-middle week-view"><thead><tr><th>시간</th>';
    weekDays.forEach(d => {
        const headerDate = (d.getMonth() + 1) + '/' + d.getDate();
        const dayName = d.toLocaleDateString('ko-KR', { weekday: 'short' });
        const headerClass = fmt(d) === fmt(new Date()) ? 'text-danger fw-bold' : '';
        html += `<th class="${headerClass}">${dayName} (${headerDate})</th>`;
    });
    html += '</tr></thead><tbody>';

    hours.forEach(h => {
        html += `<tr><td>${String(h).padStart(2, '0')}:00</td>`;
        weekDays.forEach(d => {
            const dayKey = fmt(d);
            const hourKey = String(h).padStart(2, '0');
            const fullKey = `${dayKey}_${hourKey}`;
            const count = hourlyCountsMap.get(fullKey) || 0;
            html += `<td>${count > 0 ? `<span class="text-danger fw-bold">예약 ${count}건</span>` : ''}</td>`;
        });
        html += '</tr>';
    });

    html += '<tr><td class="fw-bold bg-light">총 예약</td>';
    weekDays.forEach(d => {
        const dayKey = fmt(d);
        let totalDayCount = 0;
        hours.forEach(h => {
            const hourKey = String(h).padStart(2, '0');
            const fullKey = `${dayKey}_${hourKey}`;
            totalDayCount += (hourlyCountsMap.get(fullKey) || 0);
        });
        html += `<td class="bg-light fw-bold">총 예약 ${totalDayCount}건</td>`;
    });
    html += '</tr></tbody></table>';
    container.innerHTML = html;

    // ⭐ 툴팁 초기화: DOM이 업데이트된 후 호출 ⭐
    initTooltips();
}


function fillReservationDetailModal(data) {
    

    if (data && !data.error) {
        const detailNameElement = document.getElementById('detailName');
        const visitDateElement = document.getElementById('visitDate');
        const visitHourSelect = document.getElementById('visitHour');
        const visitMinuteSelect = document.getElementById('visitMinute');
        const detailPhoneElement = document.getElementById('detailPhone');
        const doctorDeptSelect = document.getElementById('doctorDept'); // select 요소
        const visitReasonInputElement = document.getElementById('visitReasonInput');
        const visitReasonTextareaElement = document.getElementById('visitReasonTextarea');

        if (detailNameElement) {
            detailNameElement.value = data.patientName || '';
        }

        if (visitDateElement) {
            visitDateElement.value = data.reserveDay || '';
        }

        const reserveTime = data.reserveTime || '00:00';
        const [hour, minute] = reserveTime.split(':');

        fillVisitHourOptions(hour); // visitHourSelect 채우고, 현재 시간으로 선택
        fillVisitMinuteOptions(minute); // visitMinuteSelect 채우고, 현재 분으로 선택
        
        if (detailPhoneElement) {
            detailPhoneElement.value = data.phone || '';
        }

        if (doctorDeptSelect) {
            doctorDeptSelect.selectedIndex = 0;

            const targetDept = data.department || '';
            const targetDoctor = data.employeeName || '';
            const targetEmployeeNo = data.employeeNo || '';

            for (let i = 0; i < doctorDeptSelect.options.length; i++) {
                const optionText = doctorDeptSelect.options[i].text;
                if (optionText.includes(targetDept) && optionText.includes(targetDoctor) && optionText.includes(targetEmployeeNo)) {
                    doctorDeptSelect.selectedIndex = i;
                    break;
                }
            }
        }

        if (visitReasonInputElement) {
            visitReasonInputElement.value = data.reason || '';
        }
        if (visitReasonTextareaElement) {
            visitReasonTextareaElement.value = data.reason || '';
        }

        const reservationDetailModalElement = document.getElementById('reservationDetailModal');
        if (reservationDetailModalElement) {
            reservationDetailModalElement.dataset.reserveNo = data.reserveNo;
        }

        const modalTitleElement = document.querySelector("#reservationDetailModal .modal-title");
        if (modalTitleElement) {
            modalTitleElement.innerText = "예약 상세";
        }
        
        const editBtn = document.getElementById("editBtn");
        const saveBtn = document.getElementById("saveBtn");
        const deleteBtn = document.getElementById("deleteBtn");
        const messageBtn = document.getElementById("messageBtn");

        if (editBtn) editBtn.classList.remove("d-none");
        if (saveBtn) saveBtn.classList.add("d-none");
        if (deleteBtn) deleteBtn.classList.remove("d-none");
        if (messageBtn) messageBtn.classList.remove("d-none");

        if (visitDateElement) visitDateElement.setAttribute("readonly", true);
        if (visitHourSelect) visitHourSelect.setAttribute("disabled", true); 
        if (visitMinuteSelect) visitMinuteSelect.setAttribute("disabled", true); 
        if (doctorDeptSelect) doctorDeptSelect.setAttribute("disabled", true);
        if (visitReasonTextareaElement) visitReasonTextareaElement.classList.add("d-none");
        if (visitReasonInputElement) visitReasonInputElement.classList.remove("d-none");

        toggleModal("reservationDetailModal", true);
    } else {
        alert(data.error || "예약 상세 정보를 불러오지 못했습니다.");
    }
}

function renderDay(){
    const currentDay = viewDate;
    ymSpan.textContent = fmt(currentDay); 

    const dayName = currentDay.toLocaleDateString('ko-KR', { weekday: 'long' });

    const hourlyReservationsMap = new Map();
    const currentDayKey = fmt(currentDay); 

    if (Array.isArray(fetchedDailyReservationCounts)) {
        fetchedDailyReservationCounts.forEach(item => {
          
            if (item.reserveDay === currentDayKey) {
                const hour = item.reserveTime ? item.reserveTime.substring(0, 2) : '00';
                const mapKey = `${currentDayKey}_${hour}`; 
                const reservations = hourlyReservationsMap.get(mapKey) || [];
                reservations.push(item);
                hourlyReservationsMap.set(mapKey, reservations);
            }
        });
    }

    const hours = [...Array(13)].map((_, i) => i + 7);

    let html = `
        <div class="d-flex flex-column align-items-center mb-3">
            <h3 class="fw-bold">${dayName}</h3>
        </div>
        <div class="day-view-grid d-flex">
            <div class="time-axis" style="width: 80px; text-align: right; padding-right: 10px;">
    `;
    hours.forEach(h => {
        html += `<div class="time-label" style="height: 60px; line-height: 60px;">${String(h).padStart(2, '0')}:00</div>`;
    });
    html += `
            </div>
            <div class="reservation-content flex-grow-1 border-start">
    `;

    hours.forEach(h => {
        const hourKey = String(h).padStart(2, '0');
        const fullKey = `${currentDayKey}_${hourKey}`; 

        const reservationsInHour = hourlyReservationsMap.get(fullKey) || [];

        html += `
            <div class="hour-slot">
        `;

        reservationsInHour.forEach(res => {
            const bgColorClass = 'text-bg-secondary'; 

            const displayTime = res.reserveTime ? res.reserveTime.substring(0, 5) : '';
            const blockText = `${res.patientName} 님  ${displayTime}`;
            const tooltipText = `${res.patientName} 님 (${displayTime})  ${res.department}  ${res.employeeName} 진료 예약`;

            html += `
                <div class="reservation-block badge ${bgColorClass} m-1"
                     data-bs-toggle="tooltip" data-bs-placement="top"
                     title="${tooltipText}"
                     data-reserve-no="${res.reserveNo || ''}">                      ${blockText}
                </div>
            `;
        });

        html += `
            </div>
        `;
    });

    html += `
            </div>
        </div>
    `;

    container.innerHTML = html;

 
    document.querySelectorAll('.reservation-block').forEach(block => {
        block.addEventListener('click', async (event) => {
            event.preventDefault();
            const reserveNo = block.dataset.reserveNo;

            if (!reserveNo) {
                alert('예약 번호를 찾을 수 없습니다.');
                return;
            }

            try {
                const response = await fetch(`controller?cmd=getReserveDetail&reserveNo=${reserveNo}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                
                const managerModalEl = document.getElementById("managerReservationModal");
                if (managerModalEl && bootstrap.Modal.getInstance(managerModalEl) && bootstrap.Modal.getInstance(managerModalEl)._isShown) {
                    modalStack.push(managerModalEl.id);
                    toggleModal(managerModalEl.id, false);
                }

                fillReservationDetailModal(data);
            } catch (error) {
                console.error('예약 상세 정보를 가져오는 중 오류 발생:', error);
                alert('예약 상세 정보를 불러오지 못했습니다. 다시 시도해 주세요.');
            }
        });
    });

  
    initTooltips();
}


function initTooltips() {
   
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipEl => {
        const tooltip = bootstrap.Tooltip.getInstance(tooltipEl);
        if (tooltip) {
            tooltip.dispose();
        }
    });
   
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}


// ✅ 이벤트 핸들러 변경: render() 대신 fetchAndRenderCalendarData() 호출
document.getElementById('viewSelect').addEventListener('change', e => {
    viewMode = e.target.value;
    fetchAndRenderCalendarData();
});

document.getElementById('prev').onclick = () => {
    if(viewMode === 'month') viewDate.setMonth(viewDate.getMonth() - 1);
    else if(viewMode === 'week') viewDate.setDate(viewDate.getDate() - 7);
    else viewDate.setDate(viewDate.getDate() - 1);
    fetchAndRenderCalendarData(); // 데이터 다시 가져오기
};

document.getElementById('next').onclick = () => {
    if(viewMode === 'month') viewDate.setMonth(viewDate.getMonth() + 1);
    else if(viewMode === 'week') viewDate.setDate(viewDate.getDate() + 7);
    else viewDate.setDate(viewDate.getDate() + 1);
    fetchAndRenderCalendarData(); // 데이터 다시 가져오기
};

// ✅ 페이지 로드 시 초기 캘린더 데이터를 가져옵니다.
fetchAndRenderCalendarData();

// ---------- 모달 스택 ----------
const modalStack = [];

function toggleModal(id, show = true) {
    const el = document.getElementById(id);
    const inst = bootstrap.Modal.getOrCreateInstance(el, { backdrop: 'static', keyboard: false });
    show ? inst.show() : inst.hide();
}

function modalBack(btn) {
    const modalEl = btn.closest('.modal');
    if (!modalEl) return;
    toggleModal(modalEl.id, false);
    const prev = modalStack.pop();
    if (prev) toggleModal(prev, true);
}

document.querySelectorAll('.modal-back-btn').forEach(btn => {
    btn.addEventListener('click', e => {
        e.preventDefault();
        modalBack(btn);
    });
});

// 모달에서 모달 띄울 때 스택 기록
document.querySelectorAll('[data-bs-toggle="modal"]').forEach(btn => {
    btn.addEventListener('click', () => {
        const currentModal = btn.closest('.modal');
        if (currentModal) {
            modalStack.push(currentModal.id);
            const inst = bootstrap.Modal.getInstance(currentModal);
            if (inst) inst.hide();
        }
    });
});

document.querySelectorAll('.modal').forEach(modalEl => {
    modalEl.addEventListener('hidden.bs.modal', () => {
        document.body.classList.remove('modal-open');
    });
});

// ---------- 환자 검색 ----------
(function(){
    let selected=null;

    document.querySelectorAll("#patientSearchModal tbody tr").forEach(row=>{
        row.addEventListener("click",()=>{
            if(selected) selected.classList.remove("table-active");
            row.classList.add("table-active");
            selected=row;
        });
    });
    document.getElementById("selectPatientBtn").addEventListener("click",()=>{
        if(selected){
            const tds=selected.querySelectorAll("td");
            document.getElementById("patientName").value=tds[1].innerText;
            document.getElementById("patientPhone").value=tds[2].innerText;
            toggleModal("patientSearchModal",false);
            toggleModal("reservationModal",true);
        }
    });
    const search=()=>{
        const kw=document.getElementById("patientSearchInput").value.trim();
        document.querySelectorAll("#patientSearchModal tbody tr").forEach(r=>{
            const name=r.querySelectorAll("td")[1].innerText.trim();
            r.style.display=(kw==""||name === kw)?"":"none";
        });
    };
    document.getElementById("searchBtn").addEventListener("click",search);
    document.getElementById("patientSearchInput").addEventListener("keydown",e=>{
        if(e.key==="Enter"){e.preventDefault();search();}
    });
    document.getElementById("clearSearchBtn").addEventListener("click",()=>{
        document.getElementById("patientSearchInput").value="";
        document.querySelectorAll("#patientSearchModal tbody tr").forEach(r=>r.style.display="");
    });
})();

//새로운 예약 등록 모달 (reservationModal) 관련 JavaScript
(function() {
    const reserveDateInput = document.getElementById('visitDate');
    
    const reserveHourInput = document.getElementById('visitHour');
    const reserveMinuteInput = document.getElementById('visitMinute');
    
    const doctorDeptSelect = document.getElementById('doctorDept');
    
    function fillTimeOptions() {
        // 기존 옵션 (placeholder) 유지, 나머지 삭제
        reserveHourInput.innerHTML = '<option value="" selected disabled>시</option>';
        for (let h = 8; h <= 17; h++) { // 08시부터 17시까지
            const hourValue = String(h).padStart(2, '0'); // "08", "09", ... "17"
            const option = document.createElement('option');
            option.value = hourValue;
            option.textContent = hourValue;
            reserveHourInput.appendChild(option);
        }
    }
    
    fillTimeOptions();

    async function updatePossibleDoctors() {
        const workDate = reserveDateInput.value;
        // --- 변경 시작 ---
        const selectedHour = reserveHourInput.value;    
        const selectedMinute = reserveMinuteInput.value; 

     

        // 날짜, 시, 분 중 하나라도 선택되지 않았으면 드롭다운 비활성화
        if (!workDate || !selectedHour || !selectedMinute) { 
            console.log("DEBUG: 날짜, 시, 또는 분이 선택되지 않아 의사 조회 건너뜀.");
            doctorDeptSelect.innerHTML = '<option value="">-- 날짜와 시간을 선택해주세요 --</option>';
            doctorDeptSelect.setAttribute('disabled', true);
            return;
        }

       
        // 12시 00분부터 12시 59분까지는 점심시간으로 간주하여 예약 불가
        const LUNCH_START_HOUR = 12; // 12:00
        const LUNCH_END_HOUR = 13;  // 13:00 (13:00부터 예약 가능)

        const currentHour = parseInt(selectedHour, 10);
        const currentMinute = parseInt(selectedMinute, 10);

        if (currentHour === LUNCH_START_HOUR && currentMinute === 0) { // 12:00 정각 선택 시 점심시간
            alert('점심시간(12:00 ~ 13:00)에는 예약할 수 없습니다. 다른 시간을 선택해주세요.');
            doctorDeptSelect.innerHTML = '<option value="">-- 점심시간은 예약 불가 --</option>';
            doctorDeptSelect.setAttribute('disabled', true);
            // 선택된 시간 초기화
            reserveHourInput.value = '';
            reserveMinuteInput.value = '';
            return; // 이후 로직 (서버 요청) 실행 중단
        }

        doctorDeptSelect.innerHTML = '<option value="">-- 조회 중 --</option>';
        doctorDeptSelect.setAttribute('disabled', true);
  

        try {
           
            const requestUrl = `controller?cmd=getPossibleDoctor&reserveDate=${workDate}&reserveHour=${selectedHour}&reserveMinute=${selectedMinute}`;
            
        

            const response = await fetch(requestUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const doctors = await response.json();

            // 드롭다운 초기화
            doctorDeptSelect.innerHTML = '<option value="">-- 담당의사 / 진료과 선택 --</option>';

            if (doctors && doctors.length > 0) {
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    // option.value에 의사 정보를 담아 나중에 예약 등록 시 활용
                    option.value = `${doctor.doctorScheduleNo}|${doctor.employeeNo}|${doctor.department}|${doctor.employeeName}`;
                    option.textContent = `${doctor.department} / ${doctor.employeeName}`;
                    doctorDeptSelect.appendChild(option);
                });
                doctorDeptSelect.removeAttribute('disabled'); // 가능한 의사가 있으면 활성화
            } else {
                doctorDeptSelect.innerHTML = '<option value="">-- 해당 시간에 가능한 의사가 없습니다 --</option>';
            }

        } catch (error) {
            console.error('DEBUG: 가능한 의사 목록을 가져오는 중 오류 발생:', error);
            doctorDeptSelect.innerHTML = '<option value="">-- 의사 목록 로드 실패 --</option>';
        }
    }

    // 날짜 및 새로 추가된 시/분 입력 필드에 이벤트 리스너 추가
    if (reserveDateInput) {
        reserveDateInput.addEventListener('change', updatePossibleDoctors);
    }
    // --- 변경 시작 ---
    if (reserveHourInput) {
        reserveHourInput.addEventListener('change', updatePossibleDoctors); // 시 변경 시
    }
    if (reserveMinuteInput) {
        reserveMinuteInput.addEventListener('change', updatePossibleDoctors); // 분 변경 시
    }

    // 예약 모달이 열릴 때마다 가능한 의사 목록을 다시 로드 (초기값 설정 등)
    document.getElementById('reservationModal').addEventListener('show.bs.modal', updatePossibleDoctors);
})();

// ---------- 예약 목록 ----------

let managerModalInited = false;
let suppressAutoInit = false;

(function(){
	  const table = document.getElementById('reserveTable');
	  const selectAll = table.querySelector('thead .selectAll');
	  const tbody = table.querySelector('tbody');

	  // 헤더 전체선택 클릭 -> 현재 tbody의 모든 row-check 상태 일괄 변경
	  if (selectAll) {
	    selectAll.addEventListener('change', () => {
	      const checks = tbody.querySelectorAll('.row-check');
	      checks.forEach(c => c.checked = selectAll.checked);
	    });
	  }
	  
	  
    // ✅ 예약 목록 테이블의 상세 버튼 클릭 이벤트 수정
    document.getElementById('reserveTable').addEventListener('click', async e => {
        const btn = e.target.closest('.detail-btn');
        if (!btn) return;

        const tr = btn.closest('tr');
        const reserveNo = tr.dataset.reserveNo; // tr에 설정된 data-reserve-no 값 가져오기

        if (!reserveNo) {
            alert('예약 번호를 찾을 수 없습니다.');
            return;
        }

        try {
            // 서버에 예약 상세 정보 요청
            const response = await fetch(`controller?cmd=getReserveDetail&reserveNo=${reserveNo}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // JSON 응답 파싱

            // 현재 열려있는 '전체 예약 목록' 모달 숨기기 전에 스택에 저장
            const managerReservationModal = document.getElementById("managerReservationModal");
            if (managerReservationModal && bootstrap.Modal.getInstance(managerReservationModal) && bootstrap.Modal.getInstance(managerReservationModal)._isShown) {
                modalStack.push(managerReservationModal.id);
                toggleModal(managerReservationModal.id, false);
            }

            fillReservationDetailModal(data); // 상세 모달에 데이터 채우고 열기

        } catch (error) {
            console.error('예약 상세 정보를 가져오는 중 오류 발생:', error);
            alert('예약 상세 정보를 불러오지 못했습니다. 다시 시도해 주세요.');
        }
    });
})(); 

// ===== 유틸 =====
const addDay = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
const ymd = d => { const t=new Date(d.getTime()); const Y=t.getFullYear(), M=String(t.getMonth()+1).padStart(2,'0'), D=String(t.getDate()).padStart(2,'0'); return `${Y}-${M}-${D}`; };
const formatKo = d => `${d.getMonth()+1}월 ${d.getDate()}일`;
const getMonday = d => { const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; };

// 월의 주(월~일) 목록 만들기
function buildWeeksForMonth(year, month){
  const first = new Date(year, month-1, 1);
  const last  = new Date(year, month, 0);
  let curMon  = getMonday(first);
  const weeks = [];
  while (curMon <= last){
    const start = new Date(curMon), end = addDay(start, 6);
    weeks.push({ start, end });
    curMon = addDay(curMon, 7);
  }
  return weeks;
}

// 주 셀렉트 옵션 렌더 (선택은 하지 않음 → 사용자가 직접 고르게)
function renderWeekOptions(year, month){
  const $sel = $('#filterWeek').empty().append('<option value="">주 선택</option>');
  buildWeeksForMonth(year, month).forEach(({start, end})=>{
    const val = `${ymd(start)}|${ymd(end)}`;
    const label = `${formatKo(start)} - ${formatKo(end)}`;
    $sel.append(new Option(label, val));
  });

  // 주를 강제로 자동 선택하지 않음 → day는 계속 disabled 상태 유지
  $('#filterWeekStart, #filterWeekEnd').val('');
  $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
}

// 선택된 주의 7일을 day 옵션으로 렌더
function renderDayOptionsByWeek(){
  const ws = $('#filterWeekStart').val(), we = $('#filterWeekEnd').val();
  const $day = $('#filterDay').empty();
  if (!ws || !we){
    $day.prop('disabled', true).append('<option value="">주를 먼저 선택하세요</option>');
    return;
  }
  $day.prop('disabled', false).append(new Option('전체', ''));
  const start = new Date(ws);
  for (let i=0;i<7;i++){
    const d = addDay(start, i);
    $day.append(new Option(formatKo(d), ymd(d)));
  }
  // 기본은 '전체'
  $day.val('');
}

// ===== 이벤트 바인딩 =====

// 모달 열릴 때: 오늘 월 세팅 + 주 목록 생성(자동선택 안 함) + 기본 조회(주 조건 없이 오늘/시간만으로 조회 필요시 조정)
document.getElementById('managerReservationModal')
  .addEventListener('shown.bs.modal', () => {
	if (suppressAutoInit) { suppressAutoInit = false; return; }  // ⬅ 추가
	if (managerModalInited) return;
    const today = new Date();
    const yyyy  = today.getFullYear();
    const mm    = String(today.getMonth()+1).padStart(2,'0');
    $('#filterMonth').val(`${yyyy}-${mm}`);
    $('#filterHour').val('').prop('disabled', true);
    renderWeekOptions(yyyy, parseInt(mm,10));
    // 필요하다면 여기서 오늘이 속한 주를 자동 선택하도록 바꿀 수도 있음(지금은 사용자 선택 강제)
    loadReserveList(); // 주가 비어있으면 week/day 없이 조회 (백엔드에서 month/hour만 적용되도록 <choose>로 처리)
    managerModalInited = true;
  });

// 월 변경 → 주 옵션 재생성 + day 비활성화 + 즉시 조회
$('#filterMonth').on('change', function(){
  const v = $(this).val();
  $('#filterHour').val('').prop('disabled', true);
  if (!v){
    $('#filterWeek').empty().append('<option value="">주 선택</option>');
    $('#filterWeekStart,#filterWeekEnd').val('');
    $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
    loadReserveList();
    return;
  }
  const [y, m] = v.split('-').map(Number);
  renderWeekOptions(y, m);
  loadReserveList();
});

// ✅ 주 선택 → hidden 세팅 + 7일 옵션 생성 + 즉시 조회
$('#filterWeek').on('change', function(){
  const val = $(this).val(); // "YYYY-MM-DD|YYYY-MM-DD" 또는 ""
  $('#filterHour').val('').prop('disabled', true);
  if (!val){
    $('#filterWeekStart,#filterWeekEnd').val('');
    $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
    loadReserveList();
    return;
  }
  const [ws, we] = val.split('|');
  $('#filterWeekStart').val(ws);
  $('#filterWeekEnd').val(we);
  renderDayOptionsByWeek();
  loadReserveList();
});

// 일 선택 - 주 선택시 가능
$('#filterDay').on('change', function(){
  const hasDay = (($(this).val() || '') !== '');
  if (hasDay) {
    $('#filterHour').prop('disabled', false);
  } else {
    $('#filterHour').val('').prop('disabled', true);
  }
  loadReserveList();
});

// 시간 선택 → 즉시 조회
$('#filterHour').on('change', loadReserveList);


// ===== 예약목록 조회 AJAX =====
function loadReserveList(){
  const params = {
    cmd: 'reserveListModal',
    month:     $('#filterMonth').val()     || '',
    weekStart: $('#filterWeekStart').val() || '',
    weekEnd:   $('#filterWeekEnd').val()   || '',
    day:       $('#filterDay').prop('disabled') ? '' : ($('#filterDay').val() || ''), // 주 미선택 시 day는 비움
    hour:      $('#filterHour').val()      || ''
  };
  $.ajax({
    url: 'controller',
    method: 'GET',
    dataType: 'json',
    data: params,
    success: renderReserveList,
    error: () => $('#reserveTable tbody').html('<tr><td colspan="6" class="text-danger">불러오기 실패</td></tr>')
  });
}

function renderReserveList(reserveList){
  const $tbody = $('#reserveTable tbody').empty();
  if (!reserveList || reserveList.length === 0){
    $tbody.html('<tr><td colspan="7" class="text-muted">검색 결과가 없습니다.</td></tr>');
    return;
  }
  reserveList.forEach(r=>{
	    const $tr = $('<tr>').attr('data-reserve-no', r.reserveNo || '');
	    // 체크박스 열
	    $tr.append('<td><input type="checkbox" class="row-check"></td>');
	    // 데이터 열들
	    $tr.append($('<td>').text(r.patientName  || ''));
	    $tr.append($('<td>').text(r.reserveDay   || ''));
	    $tr.append($('<td>').text(r.reserveTime  || ''));
	    $tr.append($('<td>').text(r.employeeName || ''));
	    $tr.append($('<td>').text(r.department   || ''));
	    $tr.append('<td><button type="button" class="btn btn-sm detail-btn"><img src="img/detail.png" alt="상세보기" width="24" height="24"></button></td>');
	    $tbody.append($tr);
	  });
}

//현재 뷰 기준으로 목록 열기
function openReserveListForCurrentView() {
	  suppressAutoInit = true;   // 자동 초기화 막기

	  const d = new Date(viewDate);
	  const y = d.getFullYear();
	  const m = d.getMonth() + 1;

	  // 월 세팅 + 주 옵션 렌더
	  $('#filterMonth').val(`${y}-${String(m).padStart(2,'0')}`);
	  renderWeekOptions(y, m);

	  // 공통 초기화
	  $('#filterWeek').val('');
	  $('#filterWeekStart').val('');
	  $('#filterWeekEnd').val('');
	  $('#filterDay').prop('disabled', true).empty().append('<option value="">주를 먼저 선택하세요</option>');
	  $('#filterHour').val('').prop('disabled', true);

	  if (viewMode === 'month') {
	    // month: month만 사용 (week/day/hour 비움)
	  } else if (viewMode === 'week') {
	    const mon = startOfWeekMonday(d);
	    const sun = addDays(mon, 6);
	    const val = `${ymd(mon)}|${ymd(sun)}`;

	    $('#filterWeek').val(val);
	    $('#filterWeekStart').val(ymd(mon));
	    $('#filterWeekEnd').val(ymd(sun));

	    $('#filterDay').prop('disabled', false)
	                   .empty()
	                   .append(new Option('전체',''));
	    for (let i=0;i<7;i++){
	      const dd = addDays(mon, i);
	      $('#filterDay').append(new Option(`${dd.getMonth()+1}월 ${dd.getDate()}일`, ymd(dd)));
	    }
	    $('#filterDay').val('');
	    $('#filterHour').val('').prop('disabled', true);
	  } else if (viewMode === 'day') {
	    const mon = startOfWeekMonday(d);
	    const sun = addDays(mon, 6);
	    const val = `${ymd(mon)}|${ymd(sun)}`;

	    $('#filterWeek').val(val);
	    $('#filterWeekStart').val(ymd(mon));
	    $('#filterWeekEnd').val(ymd(sun));

	    $('#filterDay').prop('disabled', false)
	                   .empty()
	                   .append(new Option('전체',''));
	    for (let i=0;i<7;i++){
	      const dd = addDays(mon, i);
	      $('#filterDay').append(new Option(`${dd.getMonth()+1}월 ${dd.getDate()}일`, ymd(dd)));
	    }
	    $('#filterDay').val(ymd(d));         // 현재 날짜 지정
	    $('#filterHour').prop('disabled', false).val(''); // 시간은 전체
	  }

	  loadReserveList();
	  const listEl = document.getElementById('managerReservationModal');
	  bootstrap.Modal.getOrCreateInstance(listEl).show();
	}

	// 버튼 클릭 시 우리가 세팅해서 열기
	document.getElementById('openListBtn').addEventListener('click', (e) => {
	  e.preventDefault(); // data-bs-toggle 기본동작 막기
	  openReserveListForCurrentView();
	});

// ---------- 예약 상세 ----------
// ---------- 예약 상세 ----------
(function() {
    // ... 기존 DOM 요소 가져오는 부분 ...
    const reservationDetailModal = document.getElementById("reservationDetailModal");
    const visitDate = document.getElementById("visitDate");
    // const time = document.getElementById("visitTime"); // 이 줄은 이제 필요 없으므로 삭제하거나 주석 처리합니다.
    const visitHourSelect = document.getElementById("visitHour"); // 새로 추가
    const visitMinuteSelect = document.getElementById("visitMinute"); // 새로 추가
    const doctor = document.getElementById("doctorDept");
    const reasonInput = document.getElementById("visitReasonInput");
    const reasonArea = document.getElementById("visitReasonTextarea");
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const messageBtn = document.getElementById("messageBtn");

    // ------- fillTimeOptions 함수 복사 및 수정 (새로운 예약 모달과 유사하게) -------
    // visitHourSelect에 시간 옵션을 채우는 함수
   // **[2-1에서 수정한 변수 선언 바로 다음 줄]** 에 붙여넣기
    // visitHourSelect에 시간 옵션을 채우는 함수
 
    
    
    
    
    
    // fillVisitHourOptions(); 
    
    // 페이지 로드 시 한 번 호출하여 시간 옵션 채우기 (아니면 editBtn 클릭 시 호출)
    // fillVisitHourOptions(); // 초기에는 disabled 상태이므로 수정 모드 진입 시 채우는 것이 더 좋습니다.
    // --------------------------------------------------------------------------



    // 수정 버튼 클릭 시 이벤트 핸들러
    editBtn.addEventListener("click", e => {
        e.preventDefault();
        visitDate.removeAttribute("readonly");
        // 기존: time.removeAttribute("readonly");
        visitHourSelect.removeAttribute("disabled"); // 시간 select 활성화
        visitMinuteSelect.removeAttribute("disabled"); // 분 select 활성화
        
        
        const currentHour = visitHourSelect.value;
        const currentMinute = visitMinuteSelect.value; // 추가
        fillVisitHourOptions(currentHour);
        fillVisitMinuteOptions(currentMinute); // ⭐ 이곳도 추가 ⭐
        
        
        doctor.removeAttribute("disabled");
        reasonInput.classList.add("d-none");
        reasonArea.classList.remove("d-none");
        reasonArea.value = reasonInput.value;

        // 모달 제목 변경
        document.querySelector("#reservationDetailModal .modal-title").innerText = "예약 수정";

        // 버튼 가시성 변경
        editBtn.classList.add("d-none"); // 수정 버튼 숨김
        saveBtn.classList.remove("d-none"); // 저장 버튼 보임
        deleteBtn.classList.add("d-none"); // 삭제 버튼 숨김
        messageBtn.classList.add("d-none"); // 메시지 보내기 버튼 숨김
    });

 // 저장 버튼 클릭 시 이벤트 핸들러
        saveBtn.addEventListener("click", async e => {
            e.preventDefault();

            const reserveNo = reservationDetailModal.dataset.reserveNo;
            
            const doctorInfo = doctor.value; // 'doctor' 변수 사용
    		let doctorScheduleNo = null;
            let employeeNo = null;
            let department = null;
            let employeeName = null;
            if (doctorInfo) {
        const parts = doctorInfo.split('|');
        // 길이가 4인지 확인하고 각 변수에 할당합니다.
        if (parts.length === 4) { 
            doctorScheduleNo = parts[0];
            employeeNo = parts[1];
            department = parts[2];
            employeeName = parts[3];
        }
    }
            
            const updatedData = {
                reserveNo: reserveNo,
                patientName: document.getElementById('detailName').value, // 'detailName' ID 직접 참조
                reserveDay: visitDate.value,
                reserveTime: `${visitHourSelect.value}:${visitMinuteSelect.value}`,
    			doctorScheduleNo: doctorScheduleNo,
                employeeNo: employeeNo,
                department: department,
                employeeName: employeeName,
                reason: reasonArea.value
            };

            if (!updatedData.reserveNo || !updatedData.patientName || !updatedData.reserveDay ||
                !updatedData.reserveTime || !updatedData.employeeNo || !updatedData.department ||
                !updatedData.employeeName || !updatedData.reason) {
                alert("모든 필수 정보를 입력하거나 선택해주세요.");
                return;
            }
            
            try {
                const response = await fetch('controller?cmd=editReserve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
            
            	if (!response.ok) {
            		throw new Error(`HTTP error! status: ${response.status}`);
            	}
            	
            	const result = await response.json();
            	
            	if (result.success) { 
            		alert('예약이 성공적으로 수정되었습니다.');
            		// UI 상태를 다시 '읽기 전용'으로 변경
            		visitDate.setAttribute("readonly", true);
            		visitHourSelect.setAttribute("disabled", true);
            		visitMinuteSelect.setAttribute("disabled", true);
            		doctor.setAttribute("disabled", true);
            		reasonInput.value = reasonArea.value;
            		reasonArea.classList.add("d-none");
            		reasonInput.classList.remove("d-none");

            		document.querySelector("#reservationDetailModal .modal-title").innerText = "예약 상세";
            		saveBtn.classList.add("d-none");
            		editBtn.classList.remove("d-none");
            		deleteBtn.classList.remove("d-none");
            		messageBtn.classList.remove("d-none");

            		fetchAndRenderCalendarData(); 
            		// 만약 managerReservationModal이 열려 있다면 목록도 새로고침
            		const managerModalEl = document.getElementById('managerReservationModal');
                    if (managerModalEl && bootstrap.Modal.getInstance(managerModalEl) && bootstrap.Modal.getInstance(managerModalEl)._isShown) {
                        // refreshManagerReservationTable(); // 이 함수는 구현 필요
                    }
            	} else {
                	alert(result.message || '예약 수정에 실패했습니다.');
            	}

            } catch (error) {
                console.error('예약 수정 중 오류 발생:', error);
                alert('예약 수정 처리 중 문제가 발생했습니다. 다시 시도해 주세요.');
            }
        });
        
     
  

    // ... (중요: 이 모달을 닫았을 때 초기 상태로 되돌리는 closeBtn 이벤트도 확인해야 합니다.)
    // 일반적으로 모달이 닫힐 때, 모든 필드를 readonly/disabled 상태로 되돌리고 버튼들도 초기 상태로 되돌리는 로직을 추가하는 것이 좋습니다.
    // 예를 들어, reservationDetailModal의 'hide.bs.modal' 이벤트 리스너를 추가하여 상태를 리셋할 수 있습니다.
    reservationDetailModal.addEventListener('hide.bs.modal', function () {
        visitDate.setAttribute("readonly", true);
        visitHourSelect.setAttribute("disabled", true);
        visitMinuteSelect.setAttribute("disabled", true);
        doctor.setAttribute("disabled", true);
        reasonArea.classList.add("d-none");
        reasonInput.classList.remove("d-none");
        document.querySelector("#reservationDetailModal .modal-title").innerText = "예약 상세";
        saveBtn.classList.add("d-none");
        editBtn.classList.remove("d-none");
        deleteBtn.classList.remove("d-none");
        messageBtn.classList.remove("d-none");
    });


    
    window.fillReservationDetailModal = fillReservationDetailModal;
    
})();

    confirmDeleteBtn.addEventListener("click", async () => {
        const deleteModalEl = document.getElementById("deleteConfirmModal");
        const deleteModal = bootstrap.Modal.getInstance(deleteModalEl);
        
      
        const reservationDetailModalEl = document.getElementById("reservationDetailModal");
        const reserveNoToDelete = reservationDetailModalEl.dataset.reserveNo;

        if (!reserveNoToDelete) {
            alert("삭제할 예약 번호를 찾을 수 없습니다.");
            if(deleteModal) deleteModal.hide();
            return;
        }

        try {
            
            const response = await fetch('controller?cmd=deleteReserve', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reserveNo: reserveNoToDelete })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json(); 

            if (result.success) {
                alert('예약이 성공적으로 삭제되었습니다.');

           
                if(deleteModal) deleteModal.hide();

                
                if (reservationDetailModalEl) {
                    const detailModal = bootstrap.Modal.getInstance(reservationDetailModalEl);
                    if (detailModal) detailModal.hide();
                }
                
                modalStack.length = 0;

              
                const managerModalEl = document.getElementById("managerReservationModal");
                if (managerModalEl) {
                    const managerModal = bootstrap.Modal.getOrCreateInstance(managerModalEl);
                    managerModal.show();
                    loadReserveList(); 
                }
                

            } else {
               
                alert(result.message || '예약 삭제에 실패했습니다.');
                if(deleteModal) deleteModal.hide(); 
            }

        } catch (error) {
            console.error('예약 삭제 중 오류 발생:', error);
            alert('예약 삭제 처리 중 오류가 발생했습니다.');
            if(deleteModal) deleteModal.hide(); 
        }
    });


//---------- 문자 보내기 이동 ----------
document.getElementById("sendReserveSMSSelectBtn").addEventListener("click", () => {
  window.location.href = "SMSService.html";
});

const params = new URLSearchParams(window.location.search);
if (params.get("tab") === "reserve") {
    // reserveBtn이 null일 가능성 처리
    const reserveButton = document.getElementById("reserveBtn");
    if (reserveButton) {
        reserveButton.click();
    }
}
</script>
</body>
</html>