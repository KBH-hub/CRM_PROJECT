<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë³´ë‚¸ ë©”ì‹œì§€í•¨</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="sidebar.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.fade-section { opacity:0; transition:opacity 0.4s ease-in-out; display:none; }
.fade-section.show { display:block; opacity:1; }

.commonSms tbody tr:hover { background-color:#f6f6f6; cursor:pointer; }

/* ê³µìš© í˜ì´ì € í•˜ë‚˜ë§Œ ìŠ¤íƒ€ì¼ë§ */
#pager .page-item.active .page-link {
  background:#212529; color:#fff; border-color:#212529; border-radius:.6rem;
}
#pager .page-item.disabled .page-link {
  color:#bbb; pointer-events:none; background:transparent; border-color:transparent;
}
#pager .page-link {
  border:none; background:transparent; color:#4a4a4a;
}

.ellipsis-cell {
  white-space: nowrap;        /* ì¤„ë°”ê¿ˆ X */
  overflow: hidden;           /* ë„˜ì¹œ ê¸€ì ìˆ¨ê¹€ */
  text-overflow: ellipsis;    /* ... í‘œì‹œ */
  max-width: 250px;           /* ì…€ í­ ê³ ì • (ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì¡°ì •) */
}

</style>
</head>
<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">

    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <!-- ë©”ì¸ -->
    <main class="col-10 p-4">
      <div class="container py-4">
        <h2 class="text-center mb-4">ë³´ë‚¸ ë©”ì‹œì§€í•¨</h2>

        <!-- íƒ­ -->
        <ul class="nav nav-tabs justify-content-center mb-3" id="messageTabs">
          <li class="nav-item"><button id="reserveBtn" class="nav-link active">ì˜ˆì•½ ë©”ì‹œì§€</button></li>
          <li class="nav-item"><button id="commonBtn" class="nav-link">ì¼ë°˜ ë©”ì‹œì§€</button></li>
        </ul>

        <!-- ì˜ˆì•½ -->
        <div class="reserveSms fade-section show text-center">
          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>ì¼ë ¨ë²ˆí˜¸</th>
                  <th>ìˆ˜ì‹ ì¸</th>
                  <th>ì „í™”ë²ˆí˜¸</th>
                  <th>ë°œì‹ ì¸</th>
                  <th>ì¼ì‹œ</th>
                  <th>í…œí”Œë¦¿ëª…</th>
                </tr>
              </thead>
              <tbody id="reserveSmsTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- ì¼ë°˜ -->
        <div class="commonSms fade-section">
          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>ì¼ë ¨ë²ˆí˜¸</th>
                  <th>ìˆ˜ì‹ ì¸</th>
                  <th>ë°œì‹ ì¸</th>
                  <th>ì „í™”ë²ˆí˜¸</th>
                  <th>ì¼ì‹œ</th>
                  <th>ë‚´ìš©</th>
                </tr>
              </thead>
              <tbody id="commonSmsTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- ğŸ”¸ ê³µìš© í˜ì´ì €: ì„¹ì…˜ ë°– ê³µí†µ ìœ„ì¹˜ì— í•˜ë‚˜ë§Œ -->
        <nav aria-label="í˜ì´ì§€ ì´ë™" class="d-flex justify-content-center my-3">
          <ul id="pager" class="pagination pagination-sm align-items-center gap-2"></ul>
        </nav>

      </div>

      <!-- ìƒì„¸ ëª¨ë‹¬ -->
      <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content border border-primary rounded-3">
            <div class="modal-header">
              <h5 class="modal-title fw-bold w-100 text-center">ë³´ë‚¸ ë©”ì‹œì§€ ìƒì„¸ë³´ê¸°</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-2">
                <div class="col-2 text-end fw-bold">ìˆ˜ì‹ ì¸</div>
                <div class="col-4" id="modalReceiver">-</div>
                <div class="col-2 text-end fw-bold">ë°œì‹ ì¸</div>
                <div class="col-4" id="modalSender">-</div>
              </div>
              <div class="row mb-2">
                <div class="col-2 text-end fw-bold">ì „í™”ë²ˆí˜¸</div>
                <div class="col-4" id="modalPhone">-</div>
                <div class="col-2 text-end fw-bold">ì¼ì‹œ</div>
                <div class="col-4" id="modalDate">-</div>
              </div>
              <div class="row mt-3">
                <div class="col-2 text-end fw-bold">ë³´ë‚¸ë‚´ìš©</div>
                <div class="col-10"><div class="bg-light p-2 rounded" id="modalContent">(ë‚´ìš© ì—†ìŒ)</div></div>
              </div>
            </div>
            <div class="modal-footer justify-content-center border-0 pb-3 pt-0">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">í™•ì¸</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// sidebar.htmlì„ ë¶ˆëŸ¬ì™€ì„œ #sidebar-slotì— ì‚½ì…
function loadSidebar(activeKey) {
  $.ajax({
    url: "./sidebar.html",
    dataType: "html",
    success: function (html) {
      $("#sidebar-slot").html(html);
      var $links = $("#sidebar-slot").find("#sidebar-nav .nav-link");
      $links.removeClass("active bg-primary text-white").addClass("text-dark");
      var $current = $links.filter("[data-route='" + activeKey + "']");
      $current.addClass("active bg-primary text-white").removeClass("text-dark");
      loadSidebarInfo();
    }
  });
}
  loadSidebar('smsService');
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  const reserveBtn = document.getElementById('reserveBtn');
  const commonBtn  = document.getElementById('commonBtn');
  const reserveSec = document.querySelector('.reserveSms');
  const commonSec  = document.querySelector('.commonSms');

  // íƒ­ ìƒíƒœ & í˜ì´ì§€ ìƒíƒœ(íƒ­ë³„)
  let activeTab = 'reserve';
  const pageSize = 10;
  let reserveCurrent = 1, reserveTotal = 1;
  let commonCurrent  = 1, commonTotal  = 1;

  function showSection(showEl, hideEl, activeBtn, inactiveBtn) {
    hideEl.classList.remove('show');
    activeBtn.classList.add('active');
    inactiveBtn.classList.remove('active');
    setTimeout(() => {
      hideEl.style.display = 'none';
      showEl.style.display = 'block';
      setTimeout(() => showEl.classList.add('show'), 10);
    }, 200);
  }

  // ë¡œë”© í•œ ì¤„ ë¨¼ì € ë³´ì—¬ì£¼ê¸°
  function renderLoading(tbodySelector, colspan = 10) {
    $(tbodySelector).html(
      `<tr><td colspan="${colspan}" class="text-center text-muted py-3">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>`
    );
  }

  // ê³µìš© í˜ì´ì € ë Œë” (í™œì„± íƒ­ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘)
  function renderPager(currentPage, totalPages) {
    const $pager = $("#pager");
    $pager.empty();
    if (!totalPages || totalPages <= 1) return;

    function addBtn(label, action, disabled, active) {
      const li = `<li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                    <button class="page-link" data-action="${action}">${label}</button></li>`;
      $pager.append(li);
    }

    addBtn("Â«", "first", currentPage === 1);
    addBtn("â€¹", "prev",  currentPage === 1);
    for (let i = 1; i <= totalPages; i++) addBtn(i, "", false, i === currentPage);
    addBtn("â€º", "next",  currentPage === totalPages);
    addBtn("Â»", "last",  currentPage === totalPages);

    $pager.find(".page-link").off("click").on("click", function() {
      const act  = $(this).data("action");
      const text = $(this).text();

      const getState = () => activeTab === 'reserve'
        ? {cur: reserveCurrent, tot: reserveTotal, go: loadReserveSms}
        : {cur: commonCurrent,  tot: commonTotal,  go: loadCommonSms};

      const {cur, tot, go} = getState();

      if ($.isNumeric(text)) go(Number(text));
      else if (act === "first") go(1);
      else if (act === "prev"  && cur > 1) go(cur - 1);
      else if (act === "next"  && cur < tot) go(cur + 1);
      else if (act === "last") go(tot);
    });
  }

  // ì˜ˆì•½ ë¡œë“œ
  function loadReserveSms(page = 1){
    const params = { cmd: "getReserveSms", page, pageSize };
    // ë¨¼ì € ë¡œë”© í‘œì‹œ(ì‚¬ìš©ì ì²´ê° â†‘)
    renderLoading('#reserveSmsTableBody', 10);

    $.ajax({
      url: "controller",
      type: "GET",
      data: params,
      dataType: "json",
      success: function(data) {
        const list = data.list || [];
        const totalCount = data.totalCount ?? 0;

        reserveTotal  = Math.max(1, Math.ceil(totalCount / pageSize));
        reserveCurrent = Math.min(Math.max(1, page), reserveTotal);

        renderReserveTable(list);
        if (activeTab === 'reserve') renderPager(reserveCurrent, reserveTotal);
      },
      error: function(xhr, status, err) {
        console.error("getReserveSms error:", status, err, xhr?.responseText);
        alert("ë³´ë‚¸ ë©”ì‹œì§€(ì˜ˆì•½) ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        renderReserveTable([]);
        if (activeTab === 'reserve') renderPager(1, 1);
      }
    });
  }

  // ì¼ë°˜ ë¡œë“œ
  function loadCommonSms(page = 1){
    const params = { cmd: "getCommonSms", page, pageSize };
    renderLoading('#commonSmsTableBody', 10);

    $.ajax({
      url: "controller",
      type: "GET",
      data: params,
      dataType: "json",
      success: function(data) {
        const list = data.list || [];
        const totalCount = data.totalCount ?? 0;

        commonTotal  = Math.max(1, Math.ceil(totalCount / pageSize));
        commonCurrent = Math.min(Math.max(1, page), commonTotal);

        renderCommonTable(list);
        if (activeTab === 'common') renderPager(commonCurrent, commonTotal);
      },
      error: function(xhr, status, err) {
        console.error("getCommonSms error:", status, err, xhr?.responseText);
        alert("ë³´ë‚¸ ë©”ì‹œì§€(ì¼ë°˜) ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        renderCommonTable([]);
        if (activeTab === 'common') renderPager(1, 1);
      }
    });
  }

  // ì˜ˆì•½ í…Œì´ë¸” ë Œë”
  function renderReserveTable(list) {
    const $tbody = $("#reserveSmsTableBody");
    $tbody.empty();
    if (!list || list.length === 0) {
      $tbody.html("<tr><td colspan='10' class='text-center text-muted py-3'>ì¡°íšŒëœ ë©”ì‹œì§€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>");
      return;
    }
    $.each(list, function(i, r) {
      const tr = `
        <tr class="message-row"
            data-receiver="${r.patientName ?? ''}"
            data-sender="${r.employeeName ?? ''}"
            data-phone="${r.phone ?? ''}"
            data-datetime="${r.datetime ?? ''}"
            data-content="${r.templateName ?? ''}">
          <td>${r.reserveSmsNo  ?? '-'}</td>
          <td>${r.patientName   ?? '-'}</td>
          <td>${r.phone         ?? '-'}</td>
          <td>${r.employeeName  ?? '-'}</td>
          <td>${r.datetime      ?? '-'}</td>
          <td>${r.templateName  ?? '-'}</td>
        </tr>`;
      $tbody.append(tr);
    });
  }

  // ì¼ë°˜ í…Œì´ë¸” ë Œë”(ì—´ ìˆœì„œ: ìˆ˜ì‹ ì¸â†’ë°œì‹ ì¸â†’ì „í™”ë²ˆí˜¸)
  function renderCommonTable(list) {
    const $tbody = $("#commonSmsTableBody");
    $tbody.empty();
    if (!list || list.length === 0) {
      $tbody.html("<tr><td colspan='10' class='text-center text-muted py-3'>ì¡°íšŒëœ ë©”ì‹œì§€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>");
      return;
    }
    $.each(list, function(i, c) {
      const tr = `
        <tr class="message-row"
            data-receiver="${c.patientName ?? ''}"
            data-sender="${c.employeeName ?? ''}"
            data-phone="${c.phone ?? ''}"
            data-datetime="${c.datetime ?? ''}"
            data-content="${c.content ?? ''}">
          <td>${c.commonSmsNo  ?? '-'}</td>
          <td>${c.patientName  ?? '-'}</td>
          <td>${c.employeeName ?? '-'}</td>
          <td>${c.phone        ?? '-'}</td>
          <td>${c.datetime     ?? '-'}</td>
          <td class="ellipsis-cell" title="${c.content ?? ''}">
          ${c.content ?? '-'}
          </td>
        </tr>`;
      $tbody.append(tr);
    });
  }

  // í–‰ í´ë¦­ â†’ ëª¨ë‹¬ (ì´ë²¤íŠ¸ ìœ„ì„)
  $(document).on('click', '.message-row', function() {
    $('#modalReceiver').text(this.dataset.receiver || '-');
    $('#modalSender').text(this.dataset.sender || '-');
    $('#modalPhone').text(this.dataset.phone || '-');
    $('#modalDate').text(this.dataset.datetime || '-');
    $('#modalContent').text(this.dataset.content || '(ë‚´ìš© ì—†ìŒ)');
    new bootstrap.Modal('#messageModal').show();
  });

  // íƒ­ í´ë¦­
  reserveBtn.addEventListener('click', () => {
    showSection(reserveSec, commonSec, reserveBtn, commonBtn);
    activeTab = 'reserve';
    if (reserveCurrent === 1 && $('#reserveSmsTableBody').children().length === 0) {
      renderLoading('#reserveSmsTableBody', 10);
    }
    loadReserveSms(1);
  });
  commonBtn.addEventListener('click', () => {
    showSection(commonSec, reserveSec, commonBtn, reserveBtn);
    activeTab = 'common';
    if (commonCurrent === 1 && $('#commonSmsTableBody').children().length === 0) {
      renderLoading('#commonSmsTableBody', 10);
    }
    loadCommonSms(1);
  });

  // ì´ˆê¸° ì§„ì…(ì¿¼ë¦¬ìŠ¤íŠ¸ë§)
  const qp = new URLSearchParams(location.search);
  if (qp.get("tab") === "common") {
    // ì´ˆê¸° í™”ë©´ì„ commonìœ¼ë¡œ
    reserveSec.classList.remove('show'); reserveSec.style.display = 'none';
    commonSec.style.display = 'block';   commonSec.classList.add('show');
    reserveBtn.classList.remove('active'); commonBtn.classList.add('active');
    activeTab = 'common';
    renderLoading('#commonSmsTableBody', 10);
    loadCommonSms(1);
  } else {
    activeTab = 'reserve';
    renderLoading('#reserveSmsTableBody', 10);
    loadReserveSms(1);
  }

})();
</script>
</body>
</html>
