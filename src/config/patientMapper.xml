<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="patientMapper">

	<resultMap id="PatientMap" type="com.crm.model.PatientVO">
		<result property="patientNo" column="patient_no" />
		<result property="patientName" column="patient_name" />
		<result property="address" column="address" />
		<result property="birth" column="birth" />
		<result property="gender" column="gender" />
		<result property="path" column="path" />
		<result property="phone" column="phone" />
		<result property="inDate" column="in_date" />
		<result property="status" column="status" />
		
		<result property="medicalDate" column="medical_date" />
	    <result property="employeeName" column="employee_name" />
	    <result property="department" column="department" />
	    <result property="diagnosis" column="diagnosis" />
	</resultMap>
	
	<resultMap id="MedicalRecordMap" type="com.crm.model.MedicalRecordVO">
		<result property="medicalNo" column="medical_no" />
		<result property="medicalDate" column="medical_date" />
		<result property="diagnosis" column="diagnosis" />
		<result property="firstCome" column="first_come" />
		<result property="employeeName" column="employee_name" />
		<result property="department" column="department" />
		<result property="content" column="content" />
		<result property="insurance" column="insurance" />
	    <result property="department" column="department" />
	    <result property="diagnosis" column="diagnosis" />
	</resultMap>
	
	<resultMap id="DoctorMap" type="com.crm.model.ManageDoctorVO">
		<result property="doctorScheduleNo" column="doctor_schedule_no" />
		<result property="doctorCode" column="doctor_code" />
		<result property="employeeName" column="employee_name" />
		<result property="department" column="department" />
		<result property="workDate" column="work_date" />
		<result property="am" column="am" />
		<result property="pm" column="pm" />
		<result property="delFlag" column="del_flag" />
	</resultMap>

	<select id="getPatientList" parameterType="map" resultMap="PatientMap">
		SELECT *
		FROM (
		  SELECT ROWNUM AS rn, A.*
		  FROM (
		    SELECT
		      P.PATIENT_NO,
		      P.PATIENT_NAME,
		      P.PHONE,
		      TO_CHAR(LATEST_MR.MEDICAL_DATE, 'YYYY-MM-DD') AS MEDICAL_DATE,
		      E.EMPLOYEE_NAME,
		      D.DEPARTMENT,
		      LATEST_MR.STATUS,
		      LATEST_MR.DIAGNOSIS
		    FROM PATIENT P
		    LEFT JOIN (
		      SELECT
		        MR.PATIENT_NO,
		        MR.MEDICAL_DATE,
		        MR.DOCTOR_CODE,
		        MR.DIAGNOSIS,
		        MR.STATUS,
		        ROW_NUMBER() OVER (PARTITION BY MR.PATIENT_NO ORDER BY MR.MEDICAL_DATE DESC, MR.MEDICAL_NO DESC) AS rn
		      FROM MEDICAL_RECORD MR
		    ) LATEST_MR
		      ON P.PATIENT_NO = LATEST_MR.PATIENT_NO
		     AND LATEST_MR.rn = 1
		    LEFT JOIN DOCTOR D
		      ON LATEST_MR.DOCTOR_CODE = D.DOCTOR_CODE
		    LEFT JOIN EMPLOYEE E
		      ON D.EMPLOYEE_ID = E.EMPLOYEE_ID
		
		    <where>
		      P.DEL_FLAG IS NULL
		      <if test="startDate != null and startDate != ''">
		        AND LATEST_MR.MEDICAL_DATE &gt;= #{startDate}
		      </if>
		      <if test="endDate != null and endDate != ''">
		        AND LATEST_MR.MEDICAL_DATE &lt;= #{endDate}
		      </if>
		      <if test="doctorCode != null and doctorCode != ''">
		        AND D.DOCTOR_CODE = #{doctorCode}
		      </if>
		      <if test="patientName != null and patientName != ''">
		        AND P.PATIENT_NAME LIKE '%' || #{patientName} || '%'
		      </if>
		      <if test="birth != null and birth != ''">
		        AND P.BIRTH LIKE #{birth} || '%'
		      </if>
		    </where>
		
		    ORDER BY P.PATIENT_NO
		  ) A
		  WHERE ROWNUM &lt;= #{endRow, jdbcType=NUMERIC}
		)
		WHERE rn &gt;= #{startRow, jdbcType=NUMERIC}
	</select>
	
	<!-- ✅ 전체 건수 -->
	<select id="getTotalCount" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM PATIENT P
	  LEFT JOIN (
	    SELECT
	      MR.PATIENT_NO,
	      MR.MEDICAL_DATE,
	      MR.DOCTOR_CODE,
	      MR.DIAGNOSIS,
	      MR.STATUS,
	      ROW_NUMBER() OVER (PARTITION BY MR.PATIENT_NO ORDER BY MR.MEDICAL_DATE DESC, MR.MEDICAL_NO DESC) AS rn
	    FROM MEDICAL_RECORD MR
	  ) LATEST_MR
	    ON P.PATIENT_NO = LATEST_MR.PATIENT_NO
	   AND LATEST_MR.rn = 1
	  LEFT JOIN DOCTOR D
	    ON LATEST_MR.DOCTOR_CODE = D.DOCTOR_CODE
	  LEFT JOIN EMPLOYEE E
	    ON D.EMPLOYEE_ID = E.EMPLOYEE_ID
	
	  <where>
	    P.DEL_FLAG IS NULL
	    <if test="startDate != null and startDate != ''">
	      AND LATEST_MR.MEDICAL_DATE &gt;= #{startDate}
	    </if>
	    <if test="endDate != null and endDate != ''">
	      AND LATEST_MR.MEDICAL_DATE &lt;= #{endDate}
	    </if>
	    <if test="doctorCode != null and doctorCode != ''">
	      AND D.DOCTOR_CODE = #{doctorCode}
	    </if>
	    <if test="patientName != null and patientName != ''">
	      AND P.PATIENT_NAME LIKE '%' || #{patientName} || '%'
	    </if>
	    <if test="birth != null and birth != ''">
	      AND P.BIRTH LIKE #{birth} || '%'
	    </if>
	  </where>
	</select>
	
	<select id="getDoctorName" parameterType="map" resultMap="DoctorMap">
	  SELECT 
	    D.DOCTOR_CODE AS doctorCode,
	    E.EMPLOYEE_NAME AS employeeName,
	    D.DEPARTMENT AS department
	  FROM (
	    SELECT DISTINCT
	      LATEST_MR.DOCTOR_CODE
	    FROM PATIENT P
	    LEFT JOIN (
	      SELECT
	        MR.PATIENT_NO,
	        MR.DOCTOR_CODE,
	        MR.MEDICAL_DATE,
	        ROW_NUMBER() OVER (
	          PARTITION BY MR.PATIENT_NO 
	          ORDER BY MR.MEDICAL_DATE DESC, MR.MEDICAL_NO DESC
	        ) AS rn
	      FROM MEDICAL_RECORD MR
	    ) LATEST_MR
	      ON P.PATIENT_NO = LATEST_MR.PATIENT_NO
	     AND LATEST_MR.rn = 1
	    <where>
	      P.DEL_FLAG IS NULL
	      <if test="startDate != null and startDate != ''">
	        AND LATEST_MR.MEDICAL_DATE &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
	      </if>
	      <if test="endDate != null and endDate != ''">
	        AND LATEST_MR.MEDICAL_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
	      </if>
	    </where>
	  ) SUB
	  INNER JOIN DOCTOR D ON SUB.DOCTOR_CODE = D.DOCTOR_CODE
	  INNER JOIN EMPLOYEE E ON D.EMPLOYEE_ID = E.EMPLOYEE_ID
	  WHERE D.DEL_FLAG IS NULL
	    AND E.DEL_FLAG IS NULL
	  ORDER BY D.DOCTOR_CODE
	</select>


	<select id="getPatientDetail" resultMap="PatientMap">
		SELECT
	    P.PATIENT_NO,
	    P.PATIENT_NAME,
	    P.PHONE,
	    P.ADDRESS,
	    TO_CHAR(P.IN_DATE, 'YYYY-MM-DD') AS IN_DATE,
	    P.BIRTH,
	    P.GENDER,
	    P.PATH,
	    E.EMPLOYEE_NAME,
	    D.DEPARTMENT,
	    LATEST_MR.STATUS
		FROM
	    PATIENT P
		LEFT JOIN (
		SELECT
	    MR.PATIENT_NO,
	    MR.DOCTOR_CODE,
	    MR.STATUS,
	    ROW_NUMBER() OVER (PARTITION BY MR.PATIENT_NO ORDER BY MR.MEDICAL_DATE DESC, MR.MEDICAL_NO DESC) AS rn
	    FROM
	    MEDICAL_RECORD MR
	    ) LATEST_MR ON P.PATIENT_NO = LATEST_MR.PATIENT_NO AND LATEST_MR.rn = 1
	    LEFT JOIN
	    DOCTOR D ON LATEST_MR.DOCTOR_CODE = D.DOCTOR_CODE
		LEFT JOIN
	    EMPLOYEE E ON D.EMPLOYEE_ID = E.EMPLOYEE_ID
		WHERE
	    P.PATIENT_NO = #{patientNo}
		AND P.DEL_FLAG IS NULL
	</select>
	
	<select id="getMedicalRecord" resultMap="MedicalRecordMap">
		SELECT
		MR.MEDICAL_NO,
		TO_CHAR(MR.MEDICAL_DATE, 'YYYY-MM-DD') AS MEDICAL_DATE,
		MR.DIAGNOSIS,
		MR.FIRST_COME,
		E.EMPLOYEE_NAME,
		D.DEPARTMENT,
		MR.CONTENT,
		MR.INSURANCE
		FROM
		MEDICAL_RECORD MR
		JOIN
		DOCTOR D ON MR.DOCTOR_CODE = D.DOCTOR_CODE
		JOIN
		EMPLOYEE E ON D.EMPLOYEE_ID = E.EMPLOYEE_ID
		WHERE
		MR.PATIENT_NO= #{patientNo}
		ORDER BY
		MR.MEDICAL_DATE DESC
	</select>
	
	<insert id="addPatient" parameterType="map">
		INSERT INTO PATIENT (
		PATIENT_NO,
		PATIENT_NAME,
		PHONE,
		IN_DATE
		) VALUES (
		PATIENT_NO.NEXTVAL,
		#{patientName}, #{phone}, SYSDATE)
	</insert>

	<update id="deletePatient">
			UPDATE PATIENT
			SET
			DEL_FLAG = SYSDATE WHERE
			PATIENT_NO = #{patientNo}
	</update>

	<update id="editPatient" parameterType="map">
		UPDATE PATIENT
		SET
		PATIENT_NAME = #{patientName},
		PHONE = #{phone},
		ADDRESS = #{address},
		BIRTH = #{birth},
		GENDER = #{gender},
		PATH = #{path}
		WHERE
		PATIENT_NO = #{patientNo}
	</update>

</mapper>